{% extends 'base.html' %}
{% block content %}
<h2>Recursos</h2>
<form method="post">
  <table class="resource-table">
    <thead>
      <tr>
        <th class="resource-order-header">Orden</th>
        <th>Recurso</th>
        <th>Visible</th>
        <th>Jornada</th>
      </tr>
    </thead>
    <tbody id="resource-list">
      {% for w in workers %}
      {% set limit = worker_limits.get(w, 'inf') %}
      <tr data-worker="{{ w }}" data-original-worker="{{ w }}">
        <td class="resource-move">
          <button type="button" class="move-btn" data-move="up" aria-label="Mover {{ w }} hacia arriba">▲</button>
          <button type="button" class="move-btn" data-move="down" aria-label="Mover {{ w }} hacia abajo">▼</button>
          <input type="hidden" name="order" value="{{ w }}">
        </td>
        <td class="resource-name">
          <input type="text" name="worker_name__{{ loop.index0 }}" value="{{ w }}" aria-label="Renombrar {{ w }}">
          <input type="hidden" name="worker_original__{{ loop.index0 }}" value="{{ w }}">
        </td>
        <td class="resource-visible"><input type="checkbox" name="worker" value="{{ w }}" {% if w not in inactive %}checked{% endif %}></td>
        <td class="resource-hours">
          <select name="hours__{{ loop.index0 }}" data-original="{{ 'inf' if limit == 'inf' else limit }}">
            <option value="inf" {% if limit == 'inf' %}selected{% endif %}>Sin límite</option>
            {% for option in hour_options %}
            <option value="{{ option }}" {% if limit != 'inf' and limit == option %}selected{% endif %}>{{ option }} h</option>
            {% endfor %}
          </select>
          <input type="hidden" name="hours_worker__{{ loop.index0 }}" value="{{ w }}">
          <input type="hidden" name="hours_changed__{{ loop.index0 }}" value="0">
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="add-worker">
    <input type="text" name="new_worker" placeholder="Nombre del recurso">
    <button type="submit" name="add_worker">Añadir recurso</button>
  </div>
  <button type="submit">Guardar</button>
</form>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('resource-list');
    if (!list) {
      return;
    }
    list.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-move]');
      if (!button) {
        return;
      }
      event.preventDefault();
      const row = button.closest('tr[data-worker]');
      if (!row) {
        return;
      }
      if (button.dataset.move === 'up') {
        const previous = row.previousElementSibling;
        if (previous) {
          list.insertBefore(row, previous);
        }
      } else if (button.dataset.move === 'down') {
        const next = row.nextElementSibling;
        if (next) {
          list.insertBefore(row, next.nextElementSibling);
        }
      }
    });
    list.addEventListener('change', (event) => {
      const select = event.target.closest('select[name^="hours__"]');
      if (!select) {
        return;
      }
      const match = select.name.match(/^hours__(\d+)$/);
      if (!match) {
        return;
      }
      const index = match[1];
      const row = select.closest('tr[data-worker]');
      if (!row) {
        return;
      }
      const changed = row.querySelector(`input[name="hours_changed__${index}"]`);
      if (!changed) {
        return;
      }
      const current = select.value || 'inf';
      const original = select.dataset.original || 'inf';
      changed.value = current === original ? '0' : '1';
    });
    list.addEventListener('input', (event) => {
      const input = event.target.closest('input[name^="worker_name__"]');
      if (!input) {
        return;
      }
      const row = input.closest('tr[data-worker]');
      if (!row) {
        return;
      }
      const match = input.name.match(/^worker_name__(\d+)$/);
      if (!match) {
        return;
      }
      const index = match[1];
      const originalField = row.querySelector(`input[name="worker_original__${index}"]`);
      const original = originalField ? originalField.value : '';
      const newName = input.value.trim() || original;
      row.dataset.worker = newName;
      const orderField = row.querySelector('input[name="order"]');
      if (orderField) {
        orderField.value = newName;
      }
      const checkbox = row.querySelector('input[name="worker"][type="checkbox"]');
      if (checkbox) {
        checkbox.value = newName;
      }
      const hoursWorker = row.querySelector(`input[name="hours_worker__${index}"]`);
      if (hoursWorker) {
        hoursWorker.value = newName;
      }
    });
  });
</script>
{% endblock %}
