{% extends 'base.html' %}
{% block content %}
<h2>Calendario pedidos</h2>
<input type="text" id="filter-input" placeholder="Filtrar por título o cliente">
<div class="pedidos-wrapper">
<table class="pedidos-calendar">
    <thead>
    <tr>
        <th>Semana</th>
        <th>Lun</th>
        <th>Mar</th>
        <th>Mié</th>
        <th>Jue</th>
        <th>Vie</th>
        <th rowspan="{{ weeks|length + 1 }}" class="unconfirmed-header">Sin fecha de entrega confirmada</th>
    </tr>
    </thead>
    <tbody>
    {% for week in weeks %}
    <tr>
        <td class="week-label">Semana {{ week.number }}</td>
        {% for d in week.days %}
        <td data-date="{{ d.date.isoformat() }}" class="{% if d.date == today %}today{% endif %}">
            {% if d.month %}<div class="month-divider">{{ d.month }}</div>{% endif %}
            <div class="day-number">{{ d.day }}</div>
            {% for t in d.tasks %}
            <div class="task" draggable="true"
                 data-pid="{{ t.get('pid') or '' }}"
                 data-phase="pedidos"
                 data-day="{{ d.date.isoformat() }}"
                 data-worker="{{ t.get('worker') or '' }}"
                 data-project="{{ t.project }}"
                 data-client="{{ t.get('client') or '' }}"
                 {% if t.get('part') %}data-part="{{ t.get('part') }}"{% endif %}
                 style="background-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.hours %}
                <span class="task-hours">{% if t.auto %}<span class="auto-hour">{{ t.hours }}h</span>{% else %}{{ t.hours }}h{% endif %}</span>
                {% endif %}
            </div>
            {% endfor %}
        </td>
        {% endfor %}
        {% if loop.first %}
        <td class="unconfirmed" rowspan="{{ weeks|length }}">
            {% for t in unconfirmed %}
            <div class="task" draggable="true"
                 data-pid="{{ t.get('pid') or '' }}"
                 data-phase="pedidos"
                 data-worker="{{ t.get('worker') or '' }}"
                 data-project="{{ t.project }}"
                 data-client="{{ t.get('client') or '' }}"
                 style="background-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.hours %}<span class="task-hours">{{ t.hours }}h</span>{% endif %}
            </div>
            {% endfor %}
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
</table>
<table class="links-table">
    <tbody>
    {% for item in project_links %}
        <tr class="project-row" data-project="{{ item.project }}" data-client="{{ item.client }}">
            <td class="project-name">
                {{ item.project }}
                {% if item.links %}
                    <ul>
                    {% for link in item.links %}
                        <li><a href="{{ link.url }}" target="_blank">{{ link.name }}</a></li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <div>Sin links</div>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const cells = document.querySelectorAll('.pedidos-calendar td:not(.week-label):not(.unconfirmed)');
  let maxH = 0;
  cells.forEach(c => { if (c.offsetHeight > maxH) maxH = c.offsetHeight; });
  cells.forEach(c => c.style.height = maxH + 'px');

  let dragged = null;
  const tasks = document.querySelectorAll('.pedidos-calendar .task');
  tasks.forEach(t => {
    t.addEventListener('dragstart', e => {
      dragged = t;
      const data = {
        pid: t.dataset.pid,
        phase: 'pedidos',
        part: t.dataset.part,
        worker: t.dataset.worker
      };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify(data));
    });
    t.addEventListener('dragend', () => { dragged = null; });
  });

  const dayCells = document.querySelectorAll('.pedidos-calendar td[data-date]');
  dayCells.forEach(cell => {
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.pid) {
        fetch("{{ url_for('move_phase') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({pid: data.pid, phase: data.phase, date: cell.dataset.date, worker: data.worker, part: data.part})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        cell.appendChild(dragged);
        dragged = null;
      }
    });
  });

  const unconfirmedCell = document.querySelector('.pedidos-calendar td.unconfirmed');
  if (unconfirmedCell) {
    unconfirmedCell.addEventListener('dragover', e => e.preventDefault());
    unconfirmedCell.addEventListener('drop', e => {
      e.preventDefault();
      if (dragged) {
        unconfirmedCell.appendChild(dragged);
        dragged = null;
      }
    });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'a' || e.key === 'A') {
      const todayCell = document.querySelector('.pedidos-calendar td.today');
      if (todayCell) {
        todayCell.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    }
  });

  const filterInput = document.getElementById('filter-input');
  filterInput.addEventListener('input', () => {
    const q = filterInput.value.toLowerCase();
    document.querySelectorAll('.pedidos-calendar .task').forEach(t => {
      const proj = (t.dataset.project || '').toLowerCase();
      const cli = (t.dataset.client || '').toLowerCase();
      t.style.display = (!q || proj.includes(q) || cli.includes(q)) ? '' : 'none';
    });
    document.querySelectorAll('.links-table .project-row').forEach(row => {
      const proj = (row.dataset.project || '').toLowerCase();
      const cli = (row.dataset.client || '').toLowerCase();
      row.style.display = (!q || proj.includes(q) || cli.includes(q)) ? '' : 'none';
    });
  });
});
</script>
{% endblock %}
