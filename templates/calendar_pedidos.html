{% extends 'base.html' %}
{% block content %}
<h2>Calendario pedidos</h2>
<input type="text" id="filter-input" placeholder="Filtrar por título o cliente">
<div class="pedidos-wrapper">
<div class="pedidos-calendar-container">
<table class="pedidos-calendar">
    <thead>
    <tr>
        <th class="week-header">Semana</th>
        <th class="day-header">Lun</th>
        <th class="day-header">Mar</th>
        <th class="day-header">Mié</th>
        <th class="day-header">Jue</th>
        <th class="day-header">Vie</th>
        <th rowspan="{{ weeks|length + 1 }}" class="unconfirmed-header">Sin fecha de entrega confirmada</th>
    </tr>
    </thead>
    <tbody>
    {% for week in weeks %}
    <tr>
        <td class="week-label">Semana {{ week.number }}</td>
        {% for d in week.days %}
        <td data-date="{{ d.date.isoformat() }}" class="day-cell{% if d.date == today %} today{% endif %}">
            {% if d.month %}<div class="month-divider">{{ d.month }}</div>{% endif %}
            <div class="day-number">{{ d.day }}</div>
            {% for t in d.tasks %}
            <div class="task" draggable="true"
                 data-pid="{{ t.get('pid') or '' }}"
                 data-phase="{{ t.get('phase') or '' }}"
                 data-day="{{ d.date.isoformat() }}"
                 data-worker="{{ t.get('worker') or '' }}"
                 data-cid="{{ t.get('cid') or '' }}"
                 data-project="{{ t.project }}"
                 data-title="{{ t.project }}"
                 data-code="{{ t.get('custom_card_id') or '' }}"
                 data-client="{{ t.get('client') or '' }}"
                 data-due="{{ d.date.isoformat() }}"
                 data-lane="{{ t.get('lane') or '' }}"
                 {% if t.get('part') %}data-part="{{ t.get('part') }}"{% endif %}
                 style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.hours %}
                <span class="task-hours">{% if t.auto %}<span class="auto-hour">{{ t.hours }}h</span>{% else %}{{ t.hours }}h{% endif %}</span>
                {% endif %}
            </div>
            {% endfor %}
        </td>
        {% endfor %}
        {% if loop.first %}
        <td class="unconfirmed" rowspan="{{ weeks|length }}">
            {% for t in unconfirmed %}
              <div class="task" draggable="true"
                   data-pid="{{ t.get('pid') or '' }}"
                   data-phase="{{ t.get('phase') or '' }}"
                   data-worker="{{ t.get('worker') or '' }}"
                   data-cid="{{ t.get('cid') or '' }}"
                   data-project="{{ t.project }}"
                   data-title="{{ t.project }}"
                   data-code="{{ t.get('custom_card_id') or '' }}"
                   data-client="{{ t.get('client') or '' }}"
                   data-lane="{{ t.get('lane') or '' }}"
                   style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.prev_date %}<span class="task-date">({{ t.prev_date }})</span>{% endif %}
                {% if t.hours %}<span class="task-hours">{{ t.hours }}h</span>{% endif %}
            </div>
            {% endfor %}
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
    </table>
</div>
<div class="columna-1">
    <div class="columna-1-title" id="columna-1-info-title" data-default-title="{{ project_info_title or '' }}">{{ project_info_title or '' }}</div>
    <h3>Columna 1</h3>
    <div class="columna-1-table-wrapper">
      <table class="columna-1-table">
        <colgroup>
          <col data-col-key="code" data-default-width="120">
          <col data-col-key="project" data-default-width="320">
          <col data-col-key="due" data-default-width="140">
          <col data-col-key="start" data-default-width="170">
          <col data-col-key="links" data-default-width="360">
        </colgroup>
        <thead>
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Proyecto</th>
            <th scope="col">Entrega</th>
            <th scope="col">Inicio planificado</th>
            <th scope="col">Fases</th>
          </tr>
        </thead>
        <tbody class="columna-1-content">
        {% for item in project_links %}
            {% set project_value = (item.project or item.title)|trim %}
            {% set title_value = (item.title or item.project)|trim %}
            {% set code_value = (item.custom_card_id or '')|trim %}
            {% set due_display = (item.due|format_due_date)|trim %}
            {% set start_display = (item.montar_start|format_due_date)|trim %}
            {% set details = item.link_details or [] %}
          <tr class="project-row"
              data-pid="{{ item.pid or '' }}"
              data-project="{{ project_value }}"
              data-title="{{ title_value }}"
              data-display="{{ (item.display_title or item.title or item.project)|trim }}"
              data-client="{{ item.client }}"
              data-code="{{ code_value }}"
              data-due="{{ item.due or '' }}"
              data-montar="{{ item.montar_start or '' }}">
            <td class="proj-code-cell">
            {% if code_value %}
              <span class="proj-code"
                    data-project="{{ project_value }}"
                    data-code="{{ code_value }}">{{ code_value }}</span>
            {% endif %}
            </td>
            <td class="proj-title-cell">
              <strong class="proj-title"
                      data-project="{{ project_value }}"
                      data-code="{{ code_value }}">{{ title_value or project_value }}</strong>
            </td>
            <td class="due-cell">
            {% if due_display %}
              <span class="proj-due">{{ due_display }}</span>
            {% endif %}
            </td>
            <td class="start-cell">
            {% if start_display %}
              <span class="proj-start">{{ start_display }}</span>
            {% endif %}
            </td>
            <td class="links-cell">
            {% for link in item.links %}
                {% set detail = details[loop.index0] if loop.index0 < details|length else {} %}
              <div class="link-title"
                   data-title="{{ link }}"
                   data-lane="{{ detail.lane or '' }}">{{ link }}</div>
            {% endfor %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
</div>
</div>
<div id="info-popup" class="info-popup"></div>
<div id="split-modal" class="conflict-modal">
  <div class="conflict-content">
    <form id="split-form">
      <div id="split-total-hours" class="split-total-hours"></div>
      <label>Horas primera parte: <input type="number" id="split-part1" min="0" required><span id="split-part1-hint" class="split-hours-hint"></span></label><br>
      <label>Horas segunda parte: <input type="number" id="split-part2" min="0" required><span id="split-part2-hint" class="split-hours-hint"></span></label><br>
      <button type="submit">Aceptar</button>
      <button type="button" id="split-cancel">Cancelar</button>
    </form>
  </div>
</div>
<div id="obs-modal" class="modal">
  <div class="modal-content">
    <textarea id="obs-text" style="width:100%;height:100px;"></textarea><br>
    <button id="obs-save" type="button">Guardar</button>
    <button id="obs-cancel" type="button">Cancelar</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const PROJECT_DATA = {{ project_data|tojson }};
  const START_DATA = {{ start_map|tojson }};
  const PHASES = {{ phases|tojson }};
  const STATIC_URL = "{{ url_for('static', filename='') }}";
  const MOVE_URL = "{{ url_for('move_phase') }}";
  const DELETE_URL = "{{ url_for('delete_phase') }}";
  const START_URL = "{{ url_for('update_phase_start') }}";
  const SPLIT_URL = "{{ url_for('split_phase_route') }}";
  const UNSPLIT_URL = "{{ url_for('unsplit_phase') }}";
  const PHASE_HOURS_URL = "{{ url_for('update_phase_hours') }}";
  const OBS_URL_TEMPLATE = "{{ url_for('update_observations', pid='__PID__') }}";
  const LAST_KEY = 'lastMoved';
  const SCROLL_KEY2 = 'scrollDate';
  const COLUMN_WIDTHS_KEY = 'columna1ColumnWidths';
  const popup = document.getElementById('info-popup');
  const splitModal = document.getElementById('split-modal');
  const splitForm = document.getElementById('split-form');
  const splitPart1 = document.getElementById('split-part1');
  const splitPart2 = document.getElementById('split-part2');
  const splitTotalDisplay = document.getElementById('split-total-hours');
  const splitPart1Hint = document.getElementById('split-part1-hint');
  const splitPart2Hint = document.getElementById('split-part2-hint');
  const splitCancel = document.getElementById('split-cancel');
  const obsModal = document.getElementById('obs-modal');
  const obsText = document.getElementById('obs-text');
  const obsSave = document.getElementById('obs-save');
  const obsCancel = document.getElementById('obs-cancel');

  const SPLIT_WORKDAY_HOURS = 8;

  function parseSplitHours(value) {
    if (value === undefined || value === null || value === '') return null;
    const num = Number(value);
    return Number.isFinite(num) ? num : null;
  }

  function toSplitInputValue(value) {
    if (!Number.isFinite(value)) return '';
    const rounded = Math.round(value * 100) / 100;
    if (Number.isInteger(rounded)) return `${rounded}`;
    return rounded.toFixed(2).replace(/0+$/, '').replace(/\.$/, '');
  }

  function formatSplitNumber(value) {
    if (!Number.isFinite(value)) return '';
    const rounded = Math.round(value * 100) / 100;
    if (Number.isInteger(rounded)) return `${rounded}`;
    return rounded.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }

  function formatSplitDuration(value) {
    if (!Number.isFinite(value)) return '';
    const total = value < 0 ? 0 : value;
    const days = Math.floor(total / SPLIT_WORKDAY_HOURS);
    const remainderRaw = total - (days * SPLIT_WORKDAY_HOURS);
    const remainder = Math.round(remainderRaw * 100) / 100;
    const parts = [];
    if (days > 0) parts.push(`${days} día${days === 1 ? '' : 's'}`);
    if (remainder > 0 || parts.length === 0) {
      const hoursText = formatSplitNumber(remainder);
      const hoursLabel = remainder === 1 ? 'hora' : 'horas';
      parts.push(`${hoursText} ${hoursLabel}`);
    }
    return parts.join(' y ');
  }

  function formatSplitHint(value) {
    const duration = formatSplitDuration(value);
    return duration ? `(${duration})` : '';
  }

  function updateSplitModalDisplay() {
    if (!splitModal) return;
    const total = parseSplitHours(splitModal.dataset.totalHours);
    if (splitTotalDisplay) {
      if (total === null) {
        splitTotalDisplay.textContent = '';
      } else {
        const baseNumber = formatSplitNumber(total);
        const hoursLabel = total === 1 ? 'hora' : 'horas';
        const duration = formatSplitDuration(total);
        splitTotalDisplay.textContent = `Total fase: ${baseNumber} ${hoursLabel}${duration ? ` (${duration})` : ''}`;
      }
    }
    if (splitPart1Hint) {
      const value = splitPart1 ? parseSplitHours(splitPart1.value) : null;
      splitPart1Hint.textContent = value === null ? '' : formatSplitHint(value);
    }
    if (splitPart2Hint) {
      const value = splitPart2 ? parseSplitHours(splitPart2.value) : null;
      splitPart2Hint.textContent = value === null ? '' : formatSplitHint(value);
    }
  }

  function handleSplitPart1Input() {
    if (!splitModal) return;
    const total = parseSplitHours(splitModal.dataset.totalHours);
    const value = splitPart1 ? parseSplitHours(splitPart1.value) : null;
    if (splitPart2) {
      if (total === null || value === null) {
        splitPart2.value = '';
      } else {
        let remainder = total - value;
        if (remainder < 0) remainder = 0;
        splitPart2.value = toSplitInputValue(remainder);
      }
    }
    updateSplitModalDisplay();
  }

  function handleSplitPart2Input() {
    updateSplitModalDisplay();
  }

  function prepareSplitModal(button) {
    if (!splitModal) return;
    const totalAttr = button ? parseSplitHours(button.dataset.totalHours) : null;
    const fallbackAttr = button ? parseSplitHours(button.dataset.hours) : null;
    const total = totalAttr !== null ? totalAttr : fallbackAttr;
    if (total !== null) {
      splitModal.dataset.totalHours = total;
    } else {
      delete splitModal.dataset.totalHours;
    }
    if (splitPart1) {
      splitPart1.value = '';
      if (total !== null) splitPart1.setAttribute('max', total);
      else splitPart1.removeAttribute('max');
    }
    if (splitPart2) {
      splitPart2.value = '';
      if (total !== null) splitPart2.setAttribute('max', total);
      else splitPart2.removeAttribute('max');
    }
    updateSplitModalDisplay();
  }

  function norm(value) {
    return (value || '').toString().trim().toLowerCase();
  }

  function resolveRowPid(row) {
    if (!row) return null;
    let pid = row.dataset.pid;
    if (pid && PROJECT_DATA[pid]) return pid;

    const code = norm(row.dataset.code);
    const project = norm(row.dataset.project);
    const title = norm(row.dataset.title);
    const display = norm(row.dataset.display);
    const client = norm(row.dataset.client);

    for (const [candidatePid, info] of Object.entries(PROJECT_DATA)) {
      if (!info) continue;
      const name = norm(info.name);
      if (!name) continue;
      const [nameProject, ...rest] = name.split(' - ');
      const nameClient = norm(rest.join(' - '));
      const projectMatch = norm(nameProject);
      const codeMatch = norm(info.custom_card_id);

      if (code && codeMatch && code === codeMatch) {
        pid = candidatePid;
      } else if (code && name.includes(code)) {
        pid = candidatePid;
      } else if (project && projectMatch === project) {
        pid = candidatePid;
      } else if (title && (name === title || name.startsWith(title) || title.startsWith(name))) {
        pid = candidatePid;
      } else if (display && name === display) {
        pid = candidatePid;
      } else if (project && name.includes(project) && (!client || !nameClient || client === nameClient)) {
        pid = candidatePid;
      }

      if (pid) {
        row.dataset.pid = pid;
        return pid;
      }
    }
    return null;
  }

  function afterMove(data, originalDate) {
    localStorage.setItem(LAST_KEY, JSON.stringify({pid: data.pid, phase: data.phase, part: data.part, date: data.date}));
    if (data.date !== originalDate) localStorage.setItem(SCROLL_KEY2, data.date);
    location.reload();
  }

  function makeDraggable(el) {
    if (!el) return;
    let startX, startY, startLeft, startTop;
    const onMouseMove = (ev) => {
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      el.style.left = startLeft + dx + 'px';
      el.style.top = startTop + dy + 'px';
    };
    const onMouseUp = () => {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    el.addEventListener('mousedown', (ev) => {
      if (ev.target.closest('input, textarea, select, button')) return;
      startX = ev.clientX;
      startY = ev.clientY;
      const rect = el.getBoundingClientRect();
      startLeft = rect.left + window.scrollX;
      startTop = rect.top + window.scrollY;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  }

  document.addEventListener('click', () => {
    if (popup) popup.style.display = 'none';
  });
  if (popup) {
    popup.addEventListener('click', (e) => e.stopPropagation());
  }

  document.querySelectorAll('.modal-content, .conflict-content, .info-popup').forEach(makeDraggable);

  if (obsCancel) {
    obsCancel.addEventListener('click', () => { if (obsModal) obsModal.style.display = 'none'; });
  }
  if (obsModal) {
    obsModal.addEventListener('click', (e) => { if (e.target === obsModal) obsModal.style.display = 'none'; });
  }
  if (obsSave) {
    obsSave.addEventListener('click', () => {
      if (!obsModal) return;
      const pid = obsModal.dataset.pid;
      const txt = obsText.value;
      const url = OBS_URL_TEMPLATE.replace('__PID__', encodeURIComponent(pid));
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ observations: txt })
      }).then(() => {
        if (PROJECT_DATA[pid]) PROJECT_DATA[pid].observations = txt;
        obsModal.style.display = 'none';
      });
    });
  }

  if (splitCancel) {
    splitCancel.addEventListener('click', () => { if (splitModal) splitModal.style.display = 'none'; });
  }
  if (splitForm && !splitForm.dataset.enhanced) {
    splitForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      fetch(SPLIT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          pid: splitModal.dataset.pid,
          phase: splitModal.dataset.phase,
          date: splitModal.dataset.date,
          part1: splitPart1.value,
          part2: splitPart2.value
        })
      }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
    });
    if (splitPart1) splitPart1.addEventListener('input', handleSplitPart1Input);
    if (splitPart2) splitPart2.addEventListener('input', handleSplitPart2Input);
    splitForm.dataset.enhanced = 'true';
  }

  function buildPhaseSection(info, context) {
    const phaseLines = [];
    PHASES.forEach(ph => {
      if (ph === 'dibujo' || ph === 'pedidos') return;
      const raw = info.phases ? info.phases[ph] : null;
      let total = 0;
      if (Array.isArray(raw)) total = raw.map(v => parseInt(v)).reduce((a,b) => a + b, 0);
      else total = parseInt(raw) || 0;
      if (total > 0) {
        const assigned = (info.assigned && info.assigned[ph]) || 'Sin planificar';
        const cls = assigned === 'Sin planificar' ? ' class="unplanned"' : ' class="planned"';
        let line = `<div${cls}>${ph}: ${total}h`;
        if (ph === context.phase) {
          line += ` <form id="phase-hours-form" style="display:inline"><input type="number" id="phase-hours-input" value="${total}" min="1" required><button type="submit" data-pid="${context.pid}" data-phase="${ph}">Cambiar horas</button></form>`;
        }
        line += `</div>`;
        phaseLines.push(line);
      }
    });
    let section = '';
    if (phaseLines.length) section += phaseLines.join('');
    if (context.phase === 'pedidos') {
      const acopio = info.phases ? info.phases['pedidos'] : null;
      if (acopio && acopio !== '0') section += `<div>Plazo acopio: ${acopio}</div>`;
    }
    return section;
  }

  function openPhasePopup(context, anchorRect) {
    if (!popup) return;
    const info = PROJECT_DATA[context.pid];
    if (!info) return;
    const headerParts = [info.name];
    if (info.blocked) headerParts[0] += ' <span class="blocked-sign">\u{1F6AB}</span>';
    headerParts.push(info.client || '');
    if (context.phase) headerParts.push(context.phase);
    let html = `<div class="popup-section popup-header"><strong>${headerParts.filter(Boolean).join(' - ')}</strong></div>`;
    const metaLines = [];
    if (info.due_date && info.due_date !== '0') metaLines.push(`<div>Límite: ${info.due_date}</div>`);
    if (info.material_confirmed_date && info.material_confirmed_date !== '0') metaLines.push(`<div>Material confirmado: ${info.material_confirmed_date}</div>`);
    if (metaLines.length) html += `<div class="popup-section">${metaLines.join('')}</div>`;
    const kanbanFields = info.kanban_display_fields || {};
    const kanbanEntries = Object.entries(kanbanFields).filter(([, value]) => value !== null && value !== undefined && `${value}`.trim() !== '');
    if (kanbanEntries.length) {
      let kanbanHtml = '<div class="popup-section kanban-extra-fields">';
      kanbanEntries.forEach(([label, value]) => {
        kanbanHtml += `<div>${label}: ${value}</div>`;
      });
      kanbanHtml += '</div>';
      html += kanbanHtml;
    }
    const phaseSection = buildPhaseSection(info, context);
    if (phaseSection) html += `<div class="popup-section">${phaseSection}</div>`;
    const actionLines = [];
    if (context.phase) {
      const startVal = (START_DATA[context.pid] && START_DATA[context.pid][context.phase]) || '';
      actionLines.push(`<div>Inicio de la fase: <form id="start-form" style="display:inline"><input type="date" id="start-input" value="${startVal}" required><button type="submit" id="start-btn" data-pid="${context.pid}" data-phase="${context.phase}">Cambiar</button></form></div>`);
      actionLines.push(`<div><button id="freeze-btn" data-pid="${context.pid}" data-phase="${context.phase}" style="color:red;font-weight:bold">${(info.frozen_phases && info.frozen_phases.includes(context.phase)) ? 'Descongelar' : 'Congelar'}</button></div>`);
      const phaseHoursEntry = info.phases ? info.phases[context.phase] : null;
      let totalPhaseHours = null;
      if (Array.isArray(phaseHoursEntry)) {
        totalPhaseHours = phaseHoursEntry
          .map(v => Number(v) || 0)
          .reduce((acc, val) => acc + val, 0);
      } else if (phaseHoursEntry !== undefined && phaseHoursEntry !== null && `${phaseHoursEntry}`.trim() !== '') {
        const parsedPhase = Number(phaseHoursEntry);
        if (Number.isFinite(parsedPhase)) totalPhaseHours = parsedPhase;
      }
      const totalHoursAttr = totalPhaseHours !== null ? ` data-total-hours="${totalPhaseHours}"` : '';
      const partHoursAttr = totalPhaseHours !== null ? ` data-hours="${totalPhaseHours}"` : '';
      let splitLine = `<div><button id="split-btn" data-pid="${context.pid}" data-phase="${context.phase}" data-date="${context.day || ''}"${totalHoursAttr}${partHoursAttr}>Dividir fase aquí</button>`;
      if (info.phases && Array.isArray(info.phases[context.phase])) {
        splitLine += ` <button id="unsplit-btn" data-pid="${context.pid}" data-phase="${context.phase}">Deshacer división</button>`;
      }
      splitLine += `</div>`;
      actionLines.push(splitLine);
      actionLines.push(`<div><button class="phase-delete-btn" id="del-btn" data-pid="${context.pid}" data-phase="${context.phase}">&#10060; Borrar fase</button></div>`);
      actionLines.push(`<div><button id="unplan-btn" data-pid="${context.pid}" data-phase="${context.phase}" data-part="${context.part || ''}">Sin planificar</button></div>`);
    }
    actionLines.push(`<div><button id="obs-btn" data-pid="${context.pid}">OBSERVACIONES</button></div>`);
    if (info.image) {
      const imgUrl = `${STATIC_URL}${info.image}`;
      actionLines.push(`<div><a href="${imgUrl}" target="_blank"><img src="${imgUrl}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
    }
    if (info.kanban_attachments && info.kanban_attachments.length) {
      info.kanban_attachments.forEach(att => {
        const url = att.url;
        const name = (att.name || '').toLowerCase();
        if (/\.(png|jpe?g|gif|webp|bmp|svg)$/.test(name)) {
          actionLines.push(`<div><a href="${url}" target="_blank"><img src="${url}" alt="${att.name || ''}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
        } else {
          actionLines.push(`<div><a href="${url}" target="_blank">${att.name || url}</a></div>`);
        }
      });
    }
    if (actionLines.length) html += `<div class="popup-section">${actionLines.join('')}</div>`;
    popup.innerHTML = html;
    popup.style.left = (anchorRect.left + window.scrollX + 5) + 'px';
    popup.style.top = (anchorRect.bottom + window.scrollY + 5) + 'px';
    popup.style.display = 'block';

    const del = document.getElementById('del-btn');
    if (del) {
      del.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('¿Borrar fase?')) {
          fetch(DELETE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ pid: del.dataset.pid, phase: del.dataset.phase })
          }).then(() => location.reload());
        }
      });
    }
    const unplan = document.getElementById('unplan-btn');
    if (unplan) {
      unplan.addEventListener('click', ev => {
        ev.stopPropagation();
        const today = madridDateISO();
        const body = { pid: unplan.dataset.pid, phase: unplan.dataset.phase, date: today, worker: 'Sin planificar' };
        if (unplan.dataset.part) body.part = unplan.dataset.part;
        fetch(MOVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        })
          .then(resp => resp.json().then(d => ({ ok: resp.ok, data: d })))
          .then(({ ok, data }) => {
            if (!ok) {
              alert(data.error || 'Error');
              return;
            }
            afterMove(data, today);
          });
      });
    }
    const obsBtn = document.getElementById('obs-btn');
    if (obsBtn && obsModal) {
      obsBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        const pid = obsBtn.dataset.pid;
        obsModal.dataset.pid = pid;
        obsText.value = (PROJECT_DATA[pid] && PROJECT_DATA[pid].observations) || '';
        obsModal.style.display = 'block';
      });
    }
    const splitBtn = document.getElementById('split-btn');
    if (splitBtn && splitModal) {
      splitBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        splitModal.dataset.pid = splitBtn.dataset.pid;
        splitModal.dataset.phase = splitBtn.dataset.phase;
        splitModal.dataset.date = splitBtn.dataset.date;
        prepareSplitModal(splitBtn);
        splitModal.style.display = 'block';
      });
    }
    const unsplitBtn = document.getElementById('unsplit-btn');
    if (unsplitBtn) {
      unsplitBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('¿Deshacer división de esta fase?')) {
          fetch(UNSPLIT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ pid: unsplitBtn.dataset.pid, phase: unsplitBtn.dataset.phase })
          }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
        }
      });
    }
    const freeze = document.getElementById('freeze-btn');
    if (freeze) {
      freeze.addEventListener('click', ev => {
        ev.stopPropagation();
        fetch('/toggle_freeze/' + freeze.dataset.pid + '/' + encodeURIComponent(freeze.dataset.phase), { method: 'POST', credentials: 'same-origin' })
          .then(() => location.reload());
      });
    }
    const startForm = document.getElementById('start-form');
    if (startForm) {
      startForm.addEventListener('submit', ev => {
        ev.preventDefault();
        ev.stopPropagation();
        const btn = document.getElementById('start-btn');
        const val = document.getElementById('start-input').value;
        fetch(START_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ pid: btn.dataset.pid, phase: btn.dataset.phase, date: val })
        }).then(resp => {
          if (!resp.ok) {
            return resp.json().then(d => { alert(d.error || 'Error'); return null; });
          }
          return resp.json();
        }).then(d => {
          if (d) {
            localStorage.setItem(LAST_KEY, JSON.stringify({pid: btn.dataset.pid, phase: btn.dataset.phase, date: d.date}));
            if (d.date !== val) localStorage.setItem(SCROLL_KEY2, d.date);
          }
          location.reload();
        });
      });
    }
    const hoursForm = document.getElementById('phase-hours-form');
    if (hoursForm) {
      hoursForm.addEventListener('submit', ev => {
        ev.preventDefault();
        ev.stopPropagation();
        const btn = hoursForm.querySelector('button');
        const val = document.getElementById('phase-hours-input').value;
        fetch(PHASE_HOURS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ pid: btn.dataset.pid, phase: btn.dataset.phase, hours: val })
        }).then(resp => {
          if (resp.ok) {
            const url = new URL(location);
            url.searchParams.set('highlight', btn.dataset.pid);
            location.href = url;
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
      });
    }
  }
  const cells = document.querySelectorAll('.pedidos-calendar td:not(.week-label):not(.unconfirmed)');
  let maxH = 0;
  cells.forEach(c => { if (c.offsetHeight > maxH) maxH = c.offsetHeight; });
  cells.forEach(c => c.style.height = maxH + 'px');

  let dragged = null;
  const tasks = document.querySelectorAll('.pedidos-calendar .task');
  tasks.forEach(t => {
    t.addEventListener('dragstart', e => {
      dragged = t;
      const data = {
        pid: t.dataset.pid,
        phase: t.dataset.phase,
        part: t.dataset.part,
        worker: t.dataset.worker,
        cid: t.dataset.cid
      };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify(data));
    });
    t.addEventListener('dragend', () => { dragged = null; });
  });

  const dayCells = document.querySelectorAll('.pedidos-calendar td[data-date]');
  dayCells.forEach(cell => {
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.pid) {
        fetch("{{ url_for('move_phase') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({pid: data.pid, phase: data.phase, date: cell.dataset.date, worker: data.worker, part: data.part})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: cell.dataset.date})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        cell.appendChild(dragged);
        dragged = null;
      }
    });
  });

  const unconfirmedCell = document.querySelector('.pedidos-calendar td.unconfirmed');
  if (unconfirmedCell) {
    unconfirmedCell.addEventListener('dragover', e => e.preventDefault());
    unconfirmedCell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: null})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        unconfirmedCell.appendChild(dragged);
        dragged = null;
      }
    });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'a' || e.key === 'A') {
      const todayCell = document.querySelector('.pedidos-calendar td.today');
      if (todayCell) {
        todayCell.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    }
  });

  const filterInput = document.getElementById('filter-input');
  filterInput.addEventListener('input', () => {
    const q = filterInput.value.toLowerCase();
    document.querySelectorAll('.pedidos-calendar .task').forEach(t => {
      const proj = (t.dataset.project || '').toLowerCase();
      const cli = (t.dataset.client || '').toLowerCase();
      const code = (t.dataset.code || '').toLowerCase();
      t.style.display = (!q || proj.includes(q) || cli.includes(q) || code.includes(q)) ? '' : 'none';
    });
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const proj = (row.dataset.project || '').toLowerCase();
      const title = (row.dataset.title || '').toLowerCase();
      const cli = (row.dataset.client || '').toLowerCase();
      const display = (row.dataset.display || '').toLowerCase();
      const code = (row.dataset.code || '').toLowerCase();
      const show = (!q || proj.includes(q) || cli.includes(q) || title.includes(q) || display.includes(q) || code.includes(q));
      row.style.display = show ? '' : 'none';
    });
  });

  function parseISODateParts(value) {
    const match = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(value || '');
    if (!match) return null;
    const year = Number(match[1]);
    const month = Number(match[2]) - 1;
    const day = Number(match[3]);
    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) return null;
    return { year, month, day };
  }

  function diffInDays(later, earlier) {
    const laterParts = parseISODateParts(later);
    const earlierParts = parseISODateParts(earlier);
    if (!laterParts || !earlierParts) return null;
    const laterUtc = Date.UTC(laterParts.year, laterParts.month, laterParts.day);
    const earlierUtc = Date.UTC(earlierParts.year, earlierParts.month, earlierParts.day);
    return Math.round((laterUtc - earlierUtc) / 86400000);
  }

  function formatDueDisplay(value) {
    const parts = parseISODateParts(value);
    if (!parts) return '';
    const day = String(parts.day).padStart(2, '0');
    const month = String(parts.month + 1).padStart(2, '0');
    const year = String(parts.year);
    return `${day}/${month}/${year}`;
  }

  function buildTaskMap() {
    const map = new Map();
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      if (!title) return;
      if (!map.has(title)) map.set(title, []);
      map.get(title).push(task);
    });
    return map;
  }

  function updateDueWarnings() {
    const taskMap = buildTaskMap();
    const dueLateTitles = new Set();
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const montarStart = row.dataset.montar || '';
      const projectDue = row.dataset.due || '';
      row.querySelectorAll('.link-title').forEach(link => {
        const title = link.dataset.title;
        const tasks = taskMap.get(title) || [];
        const calendarDates = tasks
          .map(t => t.dataset.due)
          .filter(Boolean)
          .sort();
        let referenceDate = '';
        if (calendarDates.length) {
          referenceDate = calendarDates[0];
        } else if (projectDue) {
          referenceDate = projectDue;
        }
        let isLate = false;
        if (montarStart && referenceDate) {
          const diff = diffInDays(referenceDate, montarStart);
          if (diff !== null && Math.abs(diff) <= 3) {
            isLate = true;
            dueLateTitles.add(title);
          }
        }
        link.classList.toggle('due-late', isLate);
      });
    });
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      task.classList.toggle('due-late', dueLateTitles.has(title));
    });
  }

  let columnResizeState = null;
  let columnResizeCols = [];
  let columnResizeHeaders = [];
  let columnResizeListenersAttached = false;

  function getColumnResizeClientX(event) {
    if (event.touches && event.touches.length) {
      return event.touches[0].clientX;
    }
    if (event.changedTouches && event.changedTouches.length) {
      return event.changedTouches[0].clientX;
    }
    return event.clientX;
  }

  function applyStoredColumnWidths(cols, headers, table) {
    let stored = null;
    try {
      stored = JSON.parse(localStorage.getItem(COLUMN_WIDTHS_KEY));
    } catch (err) {
      stored = null;
    }

    const widths = cols.map((col, index) => {
      const storedWidth = stored && Array.isArray(stored) ? Number(stored[index]) : NaN;
      if (Number.isFinite(storedWidth) && storedWidth > 0) {
        return storedWidth;
      }
      const defaultWidth = Number(col.dataset.defaultWidth);
      if (Number.isFinite(defaultWidth) && defaultWidth > 0) {
        return defaultWidth;
      }
      const header = headers[index];
      if (header) {
        const headerWidth = header.getBoundingClientRect().width;
        if (Number.isFinite(headerWidth) && headerWidth > 0) {
          return headerWidth;
        }
      }
      return null;
    });

    const wrapper = table ? table.parentElement : null;
    const available = wrapper ? wrapper.getBoundingClientRect().width : (table ? table.getBoundingClientRect().width : 0);
    if (available > 0) {
      const total = widths.reduce((sum, value) => sum + (Number.isFinite(value) && value > 0 ? value : 0), 0);
      if (total > 0 && total > available) {
        const minAllowed = 80 * cols.length;
        const target = Math.max(minAllowed, available);
        const scale = target / total;
        widths.forEach((value, index) => {
          if (Number.isFinite(value) && value > 0) {
            widths[index] = Math.max(80, Math.floor(value * scale));
          }
        });
      }
    }

    cols.forEach((col, index) => {
      const width = widths[index];
      if (Number.isFinite(width) && width > 0) {
        col.style.width = `${width}px`;
      } else {
        col.style.removeProperty('width');
      }
    });
  }

  function getColumnWidth(index) {
    const col = columnResizeCols[index];
    if (!col) return 0;
    const width = parseFloat(col.style.width);
    if (Number.isFinite(width) && width > 0) return width;
    const header = columnResizeHeaders[index];
    if (!header) return 0;
    return header.getBoundingClientRect().width;
  }

  function startColumnResize(event, index) {
    const col = columnResizeCols[index];
    const header = columnResizeHeaders[index];
    if (!col || !header) return;
    event.preventDefault();
    const startWidth = getColumnWidth(index);
    columnResizeState = {
      index,
      startX: getColumnResizeClientX(event),
      startWidth,
    };
    document.body.classList.add('columna-1-resizing');
  }

  function handleColumnResizeMove(event) {
    if (!columnResizeState) return;
    event.preventDefault();
    const currentX = getColumnResizeClientX(event);
    const delta = currentX - columnResizeState.startX;
    const newWidth = Math.max(80, columnResizeState.startWidth + delta);
    const col = columnResizeCols[columnResizeState.index];
    if (col) {
      col.style.width = `${newWidth}px`;
    }
  }

  function finishColumnResize() {
    if (!columnResizeState) return;
    document.body.classList.remove('columna-1-resizing');
    const widths = columnResizeCols.map((col, index) => {
      const width = parseFloat(col.style.width);
      if (Number.isFinite(width) && width > 0) return width;
      const header = columnResizeHeaders[index];
      return header ? header.getBoundingClientRect().width : null;
    });
    localStorage.setItem(COLUMN_WIDTHS_KEY, JSON.stringify(widths));
    columnResizeState = null;
  }

  function initColumnResizing() {
    const table = document.querySelector('.columna-1-table');
    if (!table) return;
    const colgroup = table.querySelector('colgroup');
    if (!colgroup) return;

    columnResizeCols = Array.from(colgroup.children);
    columnResizeHeaders = Array.from(table.querySelectorAll('thead th'));

    applyStoredColumnWidths(columnResizeCols, columnResizeHeaders, table);

    columnResizeHeaders.forEach((th, index) => {
      if (th.querySelector('.col-resize-handle')) return;
      const handle = document.createElement('span');
      handle.className = 'col-resize-handle';
      handle.addEventListener('mousedown', event => startColumnResize(event, index));
      handle.addEventListener('touchstart', event => startColumnResize(event, index), { passive: false });
      th.appendChild(handle);
    });

    if (!columnResizeListenersAttached) {
      document.addEventListener('mousemove', handleColumnResizeMove);
      document.addEventListener('mouseup', finishColumnResize);
      document.addEventListener('touchmove', handleColumnResizeMove, { passive: false });
      document.addEventListener('touchend', finishColumnResize);
      document.addEventListener('touchcancel', finishColumnResize);
      columnResizeListenersAttached = true;
    }
  }

  let currentHighlightState = null;
  let currentHighlightKey = null;

  function normalizeSelection(selection) {
    if (!selection) return null;
    if (typeof selection === 'string') {
      selection = { titles: [selection] };
    } else if (Array.isArray(selection)) {
      selection = { titles: selection };
    } else {
      selection = { ...selection };
    }

    const titles = [];
    if (selection.title) titles.push(selection.title);
    if (Array.isArray(selection.titles)) titles.push(...selection.titles);
    const normTitles = new Set();
    titles.forEach(value => {
      const key = norm(value);
      if (key) normTitles.add(key);
    });
    if (!normTitles.size) return null;

    let laneKeys = null;
    if (selection.lane) {
      const laneKey = norm(selection.lane);
      if (laneKey) {
        laneKeys = new Set([laneKey]);
      }
    }
    if (selection.lanes) {
      if (!laneKeys) laneKeys = new Set();
      for (const lane of selection.lanes) {
        const laneKey = norm(lane);
        if (laneKey) laneKeys.add(laneKey);
      }
      if (!laneKeys.size) laneKeys = null;
    }

    const key = JSON.stringify({
      titles: Array.from(normTitles).sort(),
      lanes: laneKeys ? Array.from(laneKeys).sort() : null,
    });

    return { titleKeys: normTitles, laneKeys, key };
  }

  function applyHighlight(state) {
    const wrapper = document.querySelector('.pedidos-wrapper');
    const tasks = document.querySelectorAll('.pedidos-wrapper .task');
    const links = document.querySelectorAll('.columna-1 .link-title');
    const projectRows = document.querySelectorAll('.columna-1 .project-row');
    tasks.forEach(t => {
      t.classList.remove('highlight');
      t.classList.remove('dimmed');
    });
    links.forEach(l => {
      l.classList.remove('highlight');
      l.classList.remove('dimmed');
    });
    projectRows.forEach(row => {
      row.classList.remove('highlight');
      row.classList.remove('dimmed');
    });
    if (wrapper) {
      wrapper.classList.toggle('highlight-active', !!state);
    }
    if (!state) return;

    const highlightedRows = new Set();

    tasks.forEach(t => {
      const titleKey = norm(t.dataset.title);
      const laneKey = norm(t.dataset.lane);
      if (state.titleKeys.has(titleKey) && (!state.laneKeys || state.laneKeys.has(laneKey))) {
        t.classList.add('highlight');
      } else {
        t.classList.add('dimmed');
      }
    });
    links.forEach(l => {
      const titleKey = norm(l.dataset.title);
      const laneKey = norm(l.dataset.lane);
      if (state.titleKeys.has(titleKey) && (!state.laneKeys || state.laneKeys.has(laneKey))) {
        l.classList.add('highlight');
        const row = l.closest('.project-row');
        if (row) highlightedRows.add(row);
      } else {
        l.classList.add('dimmed');
      }
    });
    projectRows.forEach(row => {
      if (highlightedRows.has(row)) {
        row.classList.add('highlight');
      } else {
        row.classList.add('dimmed');
      }
    });
  }

  function clearHighlight() {
    applyHighlight(null);
    currentHighlightState = null;
    currentHighlightKey = null;
  }

  function reapplyHighlight() {
    if (currentHighlightState) {
      applyHighlight(currentHighlightState);
    }
  }

  function toggleHighlight(selection) {
    const state = normalizeSelection(selection);
    if (!state) {
      clearHighlight();
      return;
    }
    if (currentHighlightKey && state.key === currentHighlightKey) {
      clearHighlight();
      return;
    }
    applyHighlight(state);
    currentHighlightState = state;
    currentHighlightKey = state.key;
  }

  function attachHighlightHandlers() {
    const calendar = document.querySelector('.pedidos-calendar');
    if (calendar) {
      calendar.addEventListener('click', e => {
        const t = e.target.closest('.task');
        if (!t) return;
        const title = t.dataset.title;
        if (!title) return;
        toggleHighlight({ titles: [title] });
      });
    }
    const column = document.querySelector('.columna-1');
    if (column) {
      column.addEventListener('click', e => {
        const el = e.target.closest('.link-title');
        if (!el) return;
        const title = el.dataset.title;
        if (!title) return;
        toggleHighlight({ titles: [title] });
      });
    }
  }

  attachHighlightHandlers();
  updateDueWarnings();
  initColumnResizing();

  const projectList = document.querySelector('.columna-1');
  document.querySelectorAll('.columna-1 .project-row').forEach(resolveRowPid);
  if (projectList) {
    projectList.addEventListener('click', e => {
      const trigger = e.target.closest('.proj-code, .proj-title');
      if (!trigger) return;
      const row = trigger.closest('.project-row');
      if (!row) return;
      if (trigger.classList.contains('proj-title')) {
        const matchingTitles = Array.from(row.querySelectorAll('.link-title'))
          .filter(link => norm(link.dataset.lane) === 'seguimiento compras')
          .map(link => link.dataset.title)
          .filter(Boolean);
        if (matchingTitles.length) {
          toggleHighlight({ titles: matchingTitles, lane: 'Seguimiento compras' });
        } else {
          clearHighlight();
        }
      }
      const pid = resolveRowPid(row);
      if (!pid || !PROJECT_DATA[pid]) return;
      e.stopPropagation();
      const rect = trigger.getBoundingClientRect();
      openPhasePopup({ pid }, rect);
    });
  }

  const source = new EventSource("{{ url_for('event_stream') }}");
  source.onmessage = () => {
    fetch("{{ url_for('project_links_api') }}")
      .then(r => r.json())
      .then(items => {
        const container = document.querySelector('.columna-1-content');
        if (!container) return;
        container.querySelectorAll('.project-row').forEach(r => r.remove());
        const infoTitleEl = document.getElementById('columna-1-info-title');
        if (infoTitleEl) {
          const infoNames = Array.from(new Set(items.map(item => (item.board || '').trim()).filter(Boolean)));
          if (infoNames.length) {
            const newTitle = infoNames.join(' / ');
            infoTitleEl.textContent = newTitle;
            infoTitleEl.dataset.defaultTitle = newTitle;
          } else {
            infoTitleEl.textContent = infoTitleEl.dataset.defaultTitle || '';
          }
        }

        items.forEach(item => {
          const row = document.createElement('tr');
          row.className = 'project-row';
          row.dataset.pid = item.pid || '';
          const projectValue = (item.project || item.title || '').trim();
          row.dataset.project = projectValue;
          const fullTitle = (item.title || '').trim();
          const resolvedTitle = fullTitle || projectValue;
          row.dataset.title = resolvedTitle;
          row.dataset.client = item.client || '';
          row.dataset.montar = item.montar_start || '';
          row.dataset.due = item.due || '';
          const display = (item.display_title || resolvedTitle || '').trim();
          const code = (item.custom_card_id || '').trim();
          const dueDisplay = formatDueDisplay(item.due);
          const startDisplay = formatDueDisplay(item.montar_start);
          row.dataset.display = display;
          row.dataset.code = code;

          const codeCell = document.createElement('td');
          codeCell.className = 'proj-code-cell';
          if (code) {
            const codeSpan = document.createElement('span');
            codeSpan.className = 'proj-code';
            codeSpan.dataset.project = projectValue;
            codeSpan.dataset.code = code;
            codeSpan.textContent = code;
            codeCell.appendChild(codeSpan);
          }
          row.appendChild(codeCell);

          const titleCell = document.createElement('td');
          titleCell.className = 'proj-title-cell';
          const titleStrong = document.createElement('strong');
          titleStrong.className = 'proj-title';
          titleStrong.dataset.project = projectValue;
          titleStrong.dataset.code = code;
          titleStrong.textContent = resolvedTitle;
          titleCell.appendChild(titleStrong);
          row.appendChild(titleCell);

          const dueCell = document.createElement('td');
          dueCell.className = 'due-cell';
          if (dueDisplay) {
            const dueSpan = document.createElement('span');
            dueSpan.className = 'proj-due';
            dueSpan.textContent = dueDisplay;
            dueCell.appendChild(dueSpan);
          }
          row.appendChild(dueCell);

          const startCell = document.createElement('td');
          startCell.className = 'start-cell';
          if (startDisplay) {
            const startSpan = document.createElement('span');
            startSpan.className = 'proj-start';
            startSpan.textContent = startDisplay;
            startCell.appendChild(startSpan);
          }
          row.appendChild(startCell);

          const linksCell = document.createElement('td');
          linksCell.className = 'links-cell';
          const linkDetails = Array.isArray(item.link_details) ? item.link_details : [];
          item.links.forEach((link, idx) => {
            const detail = linkDetails[idx] || {};
            const linkDiv = document.createElement('div');
            linkDiv.className = 'link-title';
            linkDiv.dataset.title = link;
            linkDiv.dataset.lane = detail && detail.lane ? detail.lane : '';
            linkDiv.textContent = link;
            linksCell.appendChild(linkDiv);
          });
          row.appendChild(linksCell);

          resolveRowPid(row);
          container.appendChild(row);
        });
        filterInput.dispatchEvent(new Event('input'));
        reapplyHighlight();
        updateDueWarnings();
      });
  };
});
</script>
{% endblock %}
