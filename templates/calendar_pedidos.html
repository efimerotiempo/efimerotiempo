{% extends 'base.html' %}
{% block content %}
<h2>Calendario pedidos</h2>
<input type="text" id="filter-input" placeholder="Filtrar por título o cliente">
<div class="pedidos-wrapper">
<div class="pedidos-calendar-container">
<table class="pedidos-calendar">
    <thead>
    <tr>
        <th class="week-header">Semana</th>
        <th class="day-header">Lun</th>
        <th class="day-header">Mar</th>
        <th class="day-header">Mié</th>
        <th class="day-header">Jue</th>
        <th class="day-header">Vie</th>
        <th rowspan="{{ weeks|length + 1 }}" class="unconfirmed-header">Sin fecha de entrega confirmada</th>
    </tr>
    </thead>
    <tbody>
    {% for week in weeks %}
    <tr>
        <td class="week-label">Semana {{ week.number }}</td>
        {% for d in week.days %}
        <td data-date="{{ d.date.isoformat() }}" class="day-cell{% if d.date == today %} today{% endif %}">
            {% if d.month %}<div class="month-divider">{{ d.month }}</div>{% endif %}
            <div class="day-number">{{ d.day }}</div>
            {% for t in d.tasks %}
            <div class="task" draggable="true"
                 data-pid="{{ t.get('pid') or '' }}"
                 data-phase="{{ t.get('phase') or '' }}"
                 data-day="{{ d.date.isoformat() }}"
                 data-worker="{{ t.get('worker') or '' }}"
                 data-cid="{{ t.get('cid') or '' }}"
                 data-project="{{ t.project }}"
                 data-title="{{ t.project }}"
                 data-code="{{ t.get('custom_card_id') or '' }}"
                 data-client="{{ t.get('client') or '' }}"
                 data-due="{{ d.date.isoformat() }}"
                 data-lane="{{ t.get('lane') or '' }}"
                 {% if t.get('part') is not none %}data-part="{{ t.get('part') }}"{% endif %}
                 style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.hours %}
                <span class="task-hours">{% if t.auto %}<span class="auto-hour">{{ t.hours }}h</span>{% else %}{{ t.hours }}h{% endif %}</span>
                {% endif %}
            </div>
            {% endfor %}
        </td>
        {% endfor %}
        {% if loop.first %}
        <td class="unconfirmed" rowspan="{{ weeks|length }}">
            {% for t in unconfirmed %}
              <div class="task" draggable="true"
                   data-pid="{{ t.get('pid') or '' }}"
                   data-phase="{{ t.get('phase') or '' }}"
                   data-worker="{{ t.get('worker') or '' }}"
                   data-cid="{{ t.get('cid') or '' }}"
                   data-project="{{ t.project }}"
                   data-title="{{ t.project }}"
                   data-code="{{ t.get('custom_card_id') or '' }}"
                   data-client="{{ t.get('client') or '' }}"
                   data-lane="{{ t.get('lane') or '' }}"
                   style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.prev_date %}<span class="task-date">({{ t.prev_date }})</span>{% endif %}
                {% if t.hours %}<span class="task-hours">{{ t.hours }}h</span>{% endif %}
            </div>
            {% endfor %}
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
    </table>
</div>
<div class="columna-1">
    <div class="columna-1-title" id="columna-1-info-title" data-default-title="{{ project_info_title or '' }}">{{ project_info_title or '' }}</div>
    <h3>Columna 1</h3>
    <div class="columna-1-table-wrapper">
      <table class="columna-1-table">
        <colgroup>
          <col data-col-key="project" data-default-width="380">
          <col data-col-key="due" data-default-width="140">
          <col data-col-key="start" data-default-width="170">
          <col data-col-key="order-date" data-default-width="160">
          <col data-col-key="order-count" data-default-width="120">
          <col data-col-key="links" data-default-width="360">
        </colgroup>
        <thead>
          <tr>
            <th scope="col">Proyecto</th>
            <th scope="col">Entrega (Fecha tope)</th>
            <th scope="col">Inicio planificado</th>
            <th scope="col">Fecha pedido</th>
            <th scope="col">Conteo</th>
            <th scope="col">Fases</th>
          </tr>
        </thead>
        <tbody class="columna-1-content">
        {% for item in project_links %}
            {% set project_value = (item.project or item.title)|trim %}
            {% set title_value = (item.title or item.project)|trim %}
            {% set code_value = (item.custom_card_id or '')|trim %}
            {% set plan_value = item.plan_start or item.montar_start %}
            {% set due_display = (item.due|format_due_date)|trim %}
            {% set start_display = (plan_value|format_due_date)|trim %}
            {% set details = item.link_details or [] %}
          <tr class="project-row"
              data-pid="{{ item.pid or '' }}"
              data-project="{{ project_value }}"
              data-title="{{ title_value }}"
              data-display="{{ (item.display_title or item.title or item.project)|trim }}"
              data-client="{{ item.client }}"
              data-code="{{ code_value }}"
              data-due="{{ item.due or '' }}"
              data-plan="{{ plan_value or '' }}">
            <td class="proj-title-cell">
              {% if code_value %}
              <span class="proj-code proj-code-badge"
                    data-project="{{ project_value }}"
                    data-code="{{ code_value }}">{{ code_value }}</span>
              {% endif %}
              <strong class="proj-title"
                      data-project="{{ project_value }}"
                      data-code="{{ code_value }}">{{ title_value or project_value }}</strong>
            </td>
            <td class="due-cell">
            {% if due_display %}
              <span class="proj-due">{{ due_display }}</span>
            {% endif %}
            </td>
            <td class="start-cell">
            {% if start_display %}
              <span class="proj-start">{{ start_display }}</span>
            {% endif %}
            </td>
            <td class="order-date-cell">
            {% for link in item.links %}
                {% set detail = details[loop.index0] if loop.index0 < details|length else {} %}
                {% set order_value = detail.order_date %}
                {% set order_raw = detail.order_date_raw %}
              <div class="order-date-entry"
                   {% if order_value %}data-order="{{ order_value }}"{% endif %}>
                {% if order_value %}
                  {{ order_value|format_due_date }}
                {% elif order_raw %}
                  {{ order_raw }}
                {% else %}
                  &nbsp;
                {% endif %}
              </div>
            {% endfor %}
            </td>
            <td class="order-count-cell">
            {% for link in item.links %}
                {% set detail = details[loop.index0] if loop.index0 < details|length else {} %}
                {% set order_days = detail.order_days %}
              <div class="order-count-entry"
                   {% if order_days is not none %}data-days="{{ order_days }}"{% endif %}>
                {% if order_days is not none %}
                  {{ order_days }}
                {% else %}
                  &nbsp;
                {% endif %}
              </div>
            {% endfor %}
            </td>
            <td class="links-cell">
            {% for link in item.links %}
                {% set detail = details[loop.index0] if loop.index0 < details|length else {} %}
                {% set column_value = detail.column|default('', true) %}
                {% set lane_value = detail.lane|default('', true) %}
                {% set tooltip = column_value %}
                {% if not tooltip and lane_value %}
                  {% set tooltip = lane_value %}
                {% elif tooltip and lane_value and lane_value != column_value %}
                  {% set tooltip = tooltip ~ ' · ' ~ lane_value %}
                {% endif %}
              <div class="link-title"
                   data-title="{{ link }}"
                   data-lane="{{ lane_value }}"
                   data-column="{{ column_value }}"
                   {% if tooltip %}title="{{ tooltip }}"{% endif %}>{{ link }}</div>
            {% endfor %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
</div>
</div>
<div id="info-popup" class="info-popup"></div>
<div id="split-modal" class="conflict-modal">
  <div class="conflict-content">
    <form id="split-form">
      <div id="split-total-hours" class="split-total-hours"></div>
      <div id="split-parts-container" class="split-parts-container"></div>
      <button type="button" id="split-add-part" class="split-add-part" title="Añadir parte">+</button>
      <div class="split-actions">
        <button type="submit">Aceptar</button>
        <button type="button" id="split-cancel">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const PROJECT_DATA = {{ project_data|tojson }};
  const START_DATA = {{ start_map|tojson }};
  const PHASES = {{ phases|tojson }};
  const STATIC_URL = "{{ url_for('static', filename='') }}";
  const MOVE_URL = "{{ url_for('move_phase') }}";
  const DELETE_URL = "{{ url_for('delete_phase') }}";
  const START_URL = "{{ url_for('update_phase_start') }}";
  const SPLIT_URL = "{{ url_for('split_phase_route') }}";
  const UNSPLIT_URL = "{{ url_for('unsplit_phase') }}";
  const PHASE_HOURS_URL = "{{ url_for('update_phase_hours') }}";
  const OBS_URL_TEMPLATE = "{{ url_for('update_observations', pid='__PID__') }}";
  const COMPLETE_URL = "{{ url_for('complete') }}";
  const LAST_KEY = 'lastMoved';
  const SCROLL_KEY2 = 'scrollDate';
  const COLUMN_WIDTHS_KEY = 'columna1ColumnWidths';
  const popup = document.getElementById('info-popup');
  const splitModal = document.getElementById('split-modal');
  const splitForm = document.getElementById('split-form');
  const splitPartsContainer = document.getElementById('split-parts-container');
  const splitAddPartButton = document.getElementById('split-add-part');
  const splitTotalDisplay = document.getElementById('split-total-hours');
  const splitCancel = document.getElementById('split-cancel');
  let splitRemainderInput = null;
  let startDayHighlightCell = null;
  const SPLIT_WORKDAY_HOURS = 8;
  const SPLIT_ORDINAL_WORDS = ['primera', 'segunda', 'tercera', 'cuarta', 'quinta', 'sexta', 'séptima', 'octava', 'novena', 'décima'];
  const pageParams = new URLSearchParams(window.location.search);
  const initialFilterValue = pageParams.get('filter');
  const initialHighlightPid = pageParams.get('highlight');
  const START_DAY_HIGHLIGHT_CLASS = 'start-day-highlight';

  function escapeHtml(value) {
    if (value === undefined || value === null) return '';
    return value
      .toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function normalizePartValue(value) {
    if (value === undefined || value === null) return '';
    const text = `${value}`.trim();
    if (!text) return '';
    const lower = text.toLowerCase();
    if (lower === 'none' || lower === 'null' || lower === 'undefined') return '';
    return text;
  }

  function formatPartSuffix(value) {
    const normalized = normalizePartValue(value);
    if (!normalized) return '';
    const num = Number(normalized);
    if (!Number.isFinite(num)) return '';
    return ` (${Math.trunc(num) + 1})`;
  }

  function parseSplitHours(value) {
    if (value === undefined || value === null || value === '') return null;
    const num = Number(value);
    return Number.isFinite(num) ? num : null;
  }

  function toSplitInputValue(value) {
    if (!Number.isFinite(value)) return '';
    const rounded = Math.round(value * 100) / 100;
    if (Number.isInteger(rounded)) return `${rounded}`;
    return rounded.toFixed(2).replace(/0+$/, '').replace(/\.$/, '');
  }

  function formatSplitNumber(value) {
    if (!Number.isFinite(value)) return '';
    const rounded = Math.round(value * 100) / 100;
    if (Number.isInteger(rounded)) return `${rounded}`;
    return rounded.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }

  function formatSplitDuration(value) {
    if (!Number.isFinite(value)) return '';
    const total = value < 0 ? 0 : value;
    const days = Math.floor(total / SPLIT_WORKDAY_HOURS);
    const remainderRaw = total - (days * SPLIT_WORKDAY_HOURS);
    const remainder = Math.round(remainderRaw * 100) / 100;
    const parts = [];
    if (days > 0) parts.push(`${days} día${days === 1 ? '' : 's'}`);
    if (remainder > 0 || parts.length === 0) {
      const hoursText = formatSplitNumber(remainder);
      const hoursLabel = remainder === 1 ? 'hora' : 'horas';
      parts.push(`${hoursText} ${hoursLabel}`);
    }
    return parts.join(' y ');
  }

  function formatSplitHint(value) {
    const duration = formatSplitDuration(value);
    return duration ? `(${duration})` : '';
  }

  function splitOrdinalLabel(index) {
    if (!Number.isInteger(index) || index < 0) return 'Horas parte';
    if (index < SPLIT_ORDINAL_WORDS.length) {
      return `Horas ${SPLIT_ORDINAL_WORDS[index]} parte`;
    }
    return `Horas parte ${index + 1}`;
  }

  function getSplitManualInputs() {
    if (!splitPartsContainer) return [];
    return Array.from(
      splitPartsContainer.querySelectorAll('input.split-part-input[data-manual="true"]')
    );
  }

  function ensureSplitRemainderInput() {
    if (!splitPartsContainer) return null;
    if (splitRemainderInput && splitRemainderInput.isConnected) {
      return splitRemainderInput;
    }
    const row = document.createElement('div');
    row.className = 'split-part-row split-remainder-row';
    const label = document.createElement('label');
    const labelSpan = document.createElement('span');
    labelSpan.className = 'split-part-label';
    label.appendChild(labelSpan);
    const input = document.createElement('input');
    input.type = 'number';
    input.readOnly = true;
    input.tabIndex = -1;
    input.className = 'split-part-input split-part-remainder';
    input.dataset.manual = 'false';
    label.appendChild(input);
    const hint = document.createElement('span');
    hint.className = 'split-hours-hint';
    label.appendChild(hint);
    row.appendChild(label);
    splitPartsContainer.appendChild(row);
    input._hintElement = hint;
    input._labelElement = labelSpan;
    splitRemainderInput = input;
    return splitRemainderInput;
  }

  function refreshSplitPartLabels() {
    const manuals = getSplitManualInputs();
    manuals.forEach((input, idx) => {
      if (input && input._labelElement) {
        input._labelElement.textContent = `${splitOrdinalLabel(idx)}:`;
      }
    });
    if (splitRemainderInput && splitRemainderInput._labelElement) {
      splitRemainderInput._labelElement.textContent = `${splitOrdinalLabel(manuals.length)}:`;
    }
  }

  function createSplitPartRow(initialValue, beforeElement) {
    if (!splitPartsContainer) return null;
    const row = document.createElement('div');
    row.className = 'split-part-row';
    const label = document.createElement('label');
    const labelSpan = document.createElement('span');
    labelSpan.className = 'split-part-label';
    label.appendChild(labelSpan);
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '1';
    input.step = '1';
    input.required = true;
    input.className = 'split-part-input';
    input.dataset.manual = 'true';
    if (initialValue !== null && Number.isFinite(initialValue) && initialValue > 0) {
      input.value = toSplitInputValue(initialValue);
    }
    input.addEventListener('input', () => {
      input.classList.remove('split-input-error');
      updateSplitModalDisplay();
    });
    label.appendChild(input);
    const hint = document.createElement('span');
    hint.className = 'split-hours-hint';
    label.appendChild(hint);
    row.appendChild(label);
    input._hintElement = hint;
    input._labelElement = labelSpan;
    if (beforeElement) {
      splitPartsContainer.insertBefore(row, beforeElement);
    } else {
      splitPartsContainer.appendChild(row);
    }
    return input;
  }

  function resetSplitParts(existingParts) {
    if (!splitPartsContainer) return;
    splitPartsContainer.innerHTML = '';
    splitRemainderInput = null;
    const normalized = Array.isArray(existingParts)
      ? existingParts
          .map(value => parseSplitHours(value))
          .filter(value => Number.isFinite(value) && value > 0)
      : [];
    let manualValues = [];
    let remainderValue = null;
    if (normalized.length >= 2) {
      manualValues = normalized.slice(0, normalized.length - 1);
      remainderValue = normalized[normalized.length - 1];
    } else if (normalized.length === 1) {
      manualValues = [normalized[0]];
    }
    if (!manualValues.length) {
      manualValues = [null];
    }
    manualValues.forEach(value => {
      createSplitPartRow(value, null);
    });
    const remainder = ensureSplitRemainderInput();
    if (remainder) {
      if (remainderValue !== null) {
        remainder.value = toSplitInputValue(remainderValue);
      } else {
        remainder.value = '';
      }
    }
    refreshSplitPartLabels();
    updateSplitModalDisplay();
  }

  function updateSplitModalDisplay() {
    if (!splitModal) return;
    const total = parseSplitHours(splitModal.dataset.totalHours);
    if (splitTotalDisplay) {
      if (total === null) {
        splitTotalDisplay.textContent = '';
      } else {
        const baseNumber = formatSplitNumber(total);
        const hoursLabel = total === 1 ? 'hora' : 'horas';
        const duration = formatSplitDuration(total);
        splitTotalDisplay.textContent = `Total fase: ${baseNumber} ${hoursLabel}${duration ? ` (${duration})` : ''}`;
      }
    }
    const manuals = getSplitManualInputs();
    let manualSum = 0;
    manuals.forEach(input => {
      const value = parseSplitHours(input.value);
      if (Number.isFinite(value)) {
        manualSum += value;
      }
      if (input._hintElement) {
        input._hintElement.textContent = Number.isFinite(value) ? formatSplitHint(value) : '';
      }
      if (total !== null && Number.isFinite(total)) {
        input.setAttribute('max', total);
      } else {
        input.removeAttribute('max');
      }
    });
    if (splitRemainderInput) {
      let remainderValue = null;
      if (total !== null && Number.isFinite(total)) {
        remainderValue = total - manualSum;
      }
      if (Number.isFinite(remainderValue)) {
        const cleanValue = Math.max(remainderValue, 0);
        splitRemainderInput.value = toSplitInputValue(cleanValue);
        splitRemainderInput.classList.toggle('split-input-error', remainderValue <= 0);
        if (splitRemainderInput._hintElement) {
          splitRemainderInput._hintElement.textContent = formatSplitHint(cleanValue);
        }
      } else {
        splitRemainderInput.value = '';
        splitRemainderInput.classList.remove('split-input-error');
        if (splitRemainderInput._hintElement) {
          splitRemainderInput._hintElement.textContent = '';
        }
      }
    }
    refreshSplitPartLabels();
  }

  function prepareSplitModal(button) {
    if (!splitModal) return;
    const totalAttr = button ? parseSplitHours(button.dataset.totalHours) : null;
    const fallbackAttr = button ? parseSplitHours(button.dataset.hours) : null;
    let total = totalAttr !== null ? totalAttr : fallbackAttr;
    let existingParts = [];
    if (button) {
      const pid = button.dataset.pid;
      const phase = button.dataset.phase;
      if (pid && phase && PROJECT_DATA[pid] && PROJECT_DATA[pid].phases) {
        const phaseEntry = PROJECT_DATA[pid].phases[phase];
        if (Array.isArray(phaseEntry)) {
          existingParts = phaseEntry;
          const computedTotal = phaseEntry
            .map(value => parseSplitHours(value))
            .filter(value => Number.isFinite(value) && value > 0)
            .reduce((acc, value) => acc + value, 0);
          if (Number.isFinite(computedTotal) && computedTotal > 0) {
            total = computedTotal;
          }
        }
      }
    }
    if (total !== null && Number.isFinite(total)) {
      splitModal.dataset.totalHours = total;
    } else {
      delete splitModal.dataset.totalHours;
    }
    resetSplitParts(existingParts);
    if (fallbackAttr && Number.isFinite(fallbackAttr)) {
      const manuals = getSplitManualInputs();
      if (manuals.length) {
        const first = manuals[0];
        const currentValue = parseSplitHours(first.value);
        if (!(Number.isFinite(currentValue) && Math.abs(currentValue - fallbackAttr) < 1e-6)) {
          first.value = toSplitInputValue(fallbackAttr);
        }
      }
    }
    updateSplitModalDisplay();
    const manuals = getSplitManualInputs();
    if (manuals.length) {
      manuals[0].focus();
    }
  }

  function pickClientDate(info) {
    if (!info) return '';
    const directCandidates = [
      info.client_date,
      info.client_due_date,
      info.customer_date,
    ];
    for (const value of directCandidates) {
      if (value === undefined || value === null) continue;
      const text = `${value}`.trim();
      if (text && text !== '0') return text;
    }
    const fields = info.kanban_display_fields || {};
    const labels = ['Fecha Cliente', 'Fecha cliente'];
    for (const label of labels) {
      const raw = fields[label];
      if (raw === undefined || raw === null) continue;
      const text = `${raw}`.trim();
      if (text) return text;
    }
    return '';
  }

  function updateSplitModalDisplay() {
    if (!splitModal) return;
    const total = parseSplitHours(splitModal.dataset.totalHours);
    if (splitTotalDisplay) {
      if (total === null) {
        splitTotalDisplay.textContent = '';
      } else {
        const baseNumber = formatSplitNumber(total);
        const hoursLabel = total === 1 ? 'hora' : 'horas';
        const duration = formatSplitDuration(total);
        splitTotalDisplay.textContent = `Total fase: ${baseNumber} ${hoursLabel}${duration ? ` (${duration})` : ''}`;
      }
    }
    if (splitPart1Hint) {
      const value = splitPart1 ? parseSplitHours(splitPart1.value) : null;
      splitPart1Hint.textContent = value === null ? '' : formatSplitHint(value);
    }
    if (splitPart2Hint) {
      const value = splitPart2 ? parseSplitHours(splitPart2.value) : null;
      splitPart2Hint.textContent = value === null ? '' : formatSplitHint(value);
    }
  }

  function handleSplitPart1Input() {
    if (!splitModal) return;
    const total = parseSplitHours(splitModal.dataset.totalHours);
    const value = splitPart1 ? parseSplitHours(splitPart1.value) : null;
    if (splitPart2) {
      if (total === null || value === null) {
        splitPart2.value = '';
      } else {
        let remainder = total - value;
        if (remainder < 0) remainder = 0;
        splitPart2.value = toSplitInputValue(remainder);
      }
    }
    updateSplitModalDisplay();
  }

  function handleSplitPart2Input() {
    updateSplitModalDisplay();
  }

  function prepareSplitModal(button) {
    if (!splitModal) return;
    const totalAttr = button ? parseSplitHours(button.dataset.totalHours) : null;
    const fallbackAttr = button ? parseSplitHours(button.dataset.hours) : null;
    const total = totalAttr !== null ? totalAttr : fallbackAttr;
    if (total !== null) {
      splitModal.dataset.totalHours = total;
    } else {
      delete splitModal.dataset.totalHours;
    }
    if (splitPart1) {
      splitPart1.value = '';
      if (total !== null) splitPart1.setAttribute('max', total);
      else splitPart1.removeAttribute('max');
    }
    if (splitPart2) {
      splitPart2.value = '';
      if (total !== null) splitPart2.setAttribute('max', total);
      else splitPart2.removeAttribute('max');
    }
    updateSplitModalDisplay();
  }

  function norm(value) {
    return (value || '').toString().trim().toLowerCase();
  }

  function resolveRowPid(row) {
    if (!row) return null;
    let pid = row.dataset.pid;
    if (pid && PROJECT_DATA[pid]) return pid;

    const code = norm(row.dataset.code);
    const project = norm(row.dataset.project);
    const title = norm(row.dataset.title);
    const display = norm(row.dataset.display);
    const client = norm(row.dataset.client);

    for (const [candidatePid, info] of Object.entries(PROJECT_DATA)) {
      if (!info) continue;
      const name = norm(info.name);
      if (!name) continue;
      const [nameProject, ...rest] = name.split(' - ');
      const nameClient = norm(rest.join(' - '));
      const projectMatch = norm(nameProject);
      const codeMatch = norm(info.custom_card_id);

      if (code && codeMatch && code === codeMatch) {
        pid = candidatePid;
      } else if (code && name.includes(code)) {
        pid = candidatePid;
      } else if (project && projectMatch === project) {
        pid = candidatePid;
      } else if (title && (name === title || name.startsWith(title) || title.startsWith(name))) {
        pid = candidatePid;
      } else if (display && name === display) {
        pid = candidatePid;
      } else if (project && name.includes(project) && (!client || !nameClient || client === nameClient)) {
        pid = candidatePid;
      }

      if (pid) {
        row.dataset.pid = pid;
        return pid;
      }
    }
    return null;
  }

  function clearStartDayHighlight() {
    if (startDayHighlightCell && startDayHighlightCell.isConnected) {
      startDayHighlightCell.classList.remove(START_DAY_HIGHLIGHT_CLASS);
    }
    startDayHighlightCell = null;
  }

  function applyStartDayHighlight(dateValue) {
    const iso = normalizeDateToIso(dateValue);
    clearStartDayHighlight();
    if (!iso) return;
    const cell = document.querySelector(`.pedidos-calendar td[data-date='${iso}']`);
    if (cell) {
      cell.classList.add(START_DAY_HIGHLIGHT_CLASS);
      startDayHighlightCell = cell;
    }
  }

  function resolvePlannedStartByPid(pid) {
    if (!pid) return '';
    const candidates = new Set();
    const startEntry = START_DATA && START_DATA[pid];
    if (startEntry && typeof startEntry === 'object') {
      Object.values(startEntry).forEach(value => {
        const iso = normalizeDateToIso(value);
        if (iso) candidates.add(iso);
      });
    }
    const info = PROJECT_DATA && PROJECT_DATA[pid];
    if (info) {
      ['plan_start', 'montar_start', 'start', 'start_date'].forEach(key => {
        const iso = normalizeDateToIso(info && info[key]);
        if (iso) candidates.add(iso);
      });
      if (info.segment_starts && typeof info.segment_starts === 'object') {
        Object.values(info.segment_starts).forEach(value => {
          const iso = normalizeDateToIso(value);
          if (iso) candidates.add(iso);
        });
      }
    }
    if (!candidates.size) return '';
    return Array.from(candidates).sort()[0];
  }

  function resolvePlannedStartFromRow(row) {
    if (!row) return '';
    const direct = normalizeDateToIso(row.dataset.plan);
    if (direct) return direct;
    const pid = resolveRowPid(row);
    if (!pid) return '';
    return resolvePlannedStartByPid(pid);
  }

  function highlightProjectStartByPid(pid) {
    applyStartDayHighlight(resolvePlannedStartByPid(pid));
  }

  function highlightProjectStartByRow(row) {
    applyStartDayHighlight(resolvePlannedStartFromRow(row));
  }

  function afterMove(data, originalDate) {
    localStorage.setItem(LAST_KEY, JSON.stringify({pid: data.pid, phase: data.phase, part: data.part, date: data.date}));
    if (data.date !== originalDate) localStorage.setItem(SCROLL_KEY2, data.date);
    location.reload();
  }

  function makeDraggable(el) {
    if (!el) return;
    let startX, startY, startLeft, startTop;
    const onMouseMove = (ev) => {
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      el.style.left = startLeft + dx + 'px';
      el.style.top = startTop + dy + 'px';
    };
    const onMouseUp = () => {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    el.addEventListener('mousedown', (ev) => {
      if (ev.target.closest('input, textarea, select, button')) return;
      startX = ev.clientX;
      startY = ev.clientY;
      const rect = el.getBoundingClientRect();
      startLeft = rect.left + window.scrollX;
      startTop = rect.top + window.scrollY;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  }

  document.addEventListener('click', () => {
    if (popup) popup.style.display = 'none';
  });
  if (popup) {
    popup.addEventListener('click', (e) => e.stopPropagation());
  }

  document.querySelectorAll('.modal-content, .conflict-content, .info-popup').forEach(makeDraggable);

  if (splitCancel) {
    splitCancel.addEventListener('click', () => { if (splitModal) splitModal.style.display = 'none'; });
  }
  if (splitForm && !splitForm.dataset.enhanced) {
    splitForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      if (!splitModal) return;
      const manuals = getSplitManualInputs();
      if (!manuals.length) {
        alert('Debes indicar al menos una parte.');
        return;
      }
      const parts = [];
      let invalid = false;
      manuals.forEach(input => {
        const value = parseSplitHours(input.value);
        if (!Number.isInteger(value) || value <= 0) {
          input.classList.add('split-input-error');
          invalid = true;
          return;
        }
        parts.push(value);
      });
      const remainderValue = splitRemainderInput ? parseSplitHours(splitRemainderInput.value) : null;
      const total = parseSplitHours(splitModal.dataset.totalHours);
      let remainderInt = null;
      if (!Number.isInteger(remainderValue) || remainderValue === null || remainderValue <= 0) {
        invalid = true;
      } else {
        remainderInt = remainderValue;
        parts.push(remainderInt);
      }
      const sumParts = parts.reduce((acc, value) => acc + value, 0);
      if (total !== null && Number.isFinite(total) && sumParts !== total) {
        invalid = true;
      }
      if (invalid) {
        alert('Revisa las horas de cada parte. Deben ser enteros positivos y sumar el total de la fase.');
        updateSplitModalDisplay();
        return;
      }
      fetch(SPLIT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          pid: splitModal.dataset.pid,
          phase: splitModal.dataset.phase,
          date: splitModal.dataset.date,
          parts,
        })
      }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
    });
    splitForm.dataset.enhanced = 'true';
  }

  if (splitAddPartButton && !splitAddPartButton.dataset.bound) {
    splitAddPartButton.addEventListener('click', ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const remainderRow = splitRemainderInput ? splitRemainderInput.closest('.split-part-row') : null;
      const input = createSplitPartRow(null, remainderRow);
      ensureSplitRemainderInput();
      updateSplitModalDisplay();
      if (input) input.focus();
    });
    splitAddPartButton.dataset.bound = 'true';
  }

  function buildPhaseSection(info, context) {
    const phaseLines = [];
    PHASES.forEach(ph => {
      if (ph === 'dibujo' || ph === 'pedidos') return;
      const raw = info.phases ? info.phases[ph] : null;
      let total = 0;
      if (Array.isArray(raw)) total = raw.map(v => parseInt(v)).reduce((a,b) => a + b, 0);
      else total = parseInt(raw) || 0;
      if (total > 0) {
        const assigned = (info.assigned && info.assigned[ph]) || 'Sin planificar';
        const classes = ['phase-entry'];
        classes.push(assigned === 'Sin planificar' ? 'unplanned' : 'planned');
        const isActivePhase = ph === context.phase;
        const partSuffix = isActivePhase ? formatPartSuffix(context.part) : '';
        let line = `<div class="${classes.join(' ')}">${ph}${partSuffix}: ${total}h`;
        if (isActivePhase) {
          const partValue = normalizePartValue(context.part);
          const partAttr = partValue ? ` data-part="${partValue}"` : '';
          line += ` <form id="phase-hours-form" style="display:inline"><input type="number" id="phase-hours-input" value="${total}" min="1" required><button type="submit" data-pid="${context.pid}" data-phase="${ph}"${partAttr}>Cambiar horas</button></form>`;
        }
        line += `</div>`;
        phaseLines.push(line);
      }
    });
    let section = '';
    if (phaseLines.length) section += phaseLines.join('');
    if (context.phase === 'pedidos') {
      const acopio = info.phases ? info.phases['pedidos'] : null;
      if (acopio && acopio !== '0') section += `<div>Plazo acopio: ${acopio}</div>`;
    }
    return section;
  }

  function openPhasePopup(context, anchorRect) {
    if (!popup) return;
    const info = PROJECT_DATA[context.pid];
    if (!info) return;
    const headerParts = [info.name];
    if (info.blocked) headerParts[0] += ' <span class="blocked-sign">\u{1F6AB}</span>';
    headerParts.push(info.client || '');
    if (context.phase) headerParts.push(`${context.phase}${formatPartSuffix(context.part)}`);
    let html = `<div class="popup-section popup-header"><strong>${headerParts.filter(Boolean).join(' - ')}</strong></div>`;
    const metaLines = [];
    const clientDate = pickClientDate(info);
    if (clientDate) metaLines.push(`<div>Fecha cliente: ${clientDate}</div>`);
    const safeProjectAttr = escapeHtml(context.project || info.name || '');
    const safePidAttr = escapeHtml(context.pid || '');
    metaLines.push(`<div><button type="button" class="view-calendar-btn" data-project="${safeProjectAttr}" data-pid="${safePidAttr}">Ver calendario</button></div>`);
    if (info.due_date && info.due_date !== '0') metaLines.push(`<div>Límite: ${info.due_date}</div>`);
    if (info.material_confirmed_date && info.material_confirmed_date !== '0') metaLines.push(`<div>Material confirmado: ${info.material_confirmed_date}</div>`);
    if (metaLines.length) html += `<div class="popup-section">${metaLines.join('')}</div>`;
    const kanbanFields = info.kanban_display_fields || {};
    const kanbanEntries = Object.entries(kanbanFields).filter(([, value]) => value !== null && value !== undefined && `${value}`.trim() !== '');
    if (kanbanEntries.length) {
      let kanbanHtml = '<div class="popup-section kanban-extra-fields">';
      kanbanEntries.forEach(([label, value]) => {
        kanbanHtml += `<div>${label}: ${value}</div>`;
      });
      kanbanHtml += '</div>';
      html += kanbanHtml;
    }
    const phaseSection = buildPhaseSection(info, context);
    if (phaseSection) html += `<div class="popup-section">${phaseSection}</div>`;
    const actionLines = [];
    if (context.phase) {
      const startVal = (START_DATA[context.pid] && START_DATA[context.pid][context.phase]) || '';
      actionLines.push(`<div>Inicio de la fase: <form id="start-form" style="display:inline"><input type="date" id="start-input" value="${startVal}" required><button type="submit" id="start-btn" data-pid="${context.pid}" data-phase="${context.phase}">Cambiar</button></form></div>`);
      actionLines.push(`<div><button id="freeze-btn" data-pid="${context.pid}" data-phase="${context.phase}" style="color:red;font-weight:bold">${(info.frozen_phases && info.frozen_phases.includes(context.phase)) ? 'Descongelar' : 'Congelar'}</button></div>`);
      const phaseHoursEntry = info.phases ? info.phases[context.phase] : null;
      let totalPhaseHours = null;
      if (Array.isArray(phaseHoursEntry)) {
        totalPhaseHours = phaseHoursEntry
          .map(v => Number(v) || 0)
          .reduce((acc, val) => acc + val, 0);
      } else if (phaseHoursEntry !== undefined && phaseHoursEntry !== null && `${phaseHoursEntry}`.trim() !== '') {
        const parsedPhase = Number(phaseHoursEntry);
        if (Number.isFinite(parsedPhase)) totalPhaseHours = parsedPhase;
      }
      const totalHoursAttr = totalPhaseHours !== null ? ` data-total-hours="${totalPhaseHours}"` : '';
      const partHoursAttr = totalPhaseHours !== null ? ` data-hours="${totalPhaseHours}"` : '';
      let splitLine = `<div><button id="split-btn" data-pid="${context.pid}" data-phase="${context.phase}" data-date="${context.day || ''}"${totalHoursAttr}${partHoursAttr}>Dividir fase aquí</button>`;
      if (info.phases && Array.isArray(info.phases[context.phase])) {
        splitLine += ` <button id="unsplit-btn" data-pid="${context.pid}" data-phase="${context.phase}">Deshacer división</button>`;
      }
      splitLine += `</div>`;
      actionLines.push(splitLine);
      actionLines.push(`<div><button class="phase-delete-btn" id="del-btn" data-pid="${context.pid}" data-phase="${context.phase}">&#10060; Borrar fase</button></div>`);
      const unplanPart = normalizePartValue(context.part);
      const unplanAttr = unplanPart ? ` data-part="${unplanPart}"` : '';
      actionLines.push(`<div><button id="unplan-btn" data-pid="${context.pid}" data-phase="${context.phase}"${unplanAttr}>Sin planificar</button></div>`);
    }
    const obsValue = info && info.observations !== undefined && info.observations !== null
      ? `${info.observations}`
      : '';
    const safeObsValue = escapeHtml(obsValue);
    actionLines.push(`
      <div class="popup-observations">
        <label for="obs-text">Observaciones</label>
        <textarea id="obs-text" data-pid="${context.pid}" class="popup-observations-text">${safeObsValue}</textarea>
        <div class="popup-observations-actions">
          <button type="button" id="obs-save" data-pid="${context.pid}">Guardar</button>
        </div>
      </div>
    `);
    if (info.image) {
      const imgUrl = `${STATIC_URL}${info.image}`;
      actionLines.push(`<div><a href="${imgUrl}" target="_blank"><img src="${imgUrl}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
    }
    if (info.kanban_attachments && info.kanban_attachments.length) {
      info.kanban_attachments.forEach(att => {
        const url = att.url;
        const name = (att.name || '').toLowerCase();
        if (/\.(png|jpe?g|gif|webp|bmp|svg)$/.test(name)) {
          actionLines.push(`<div><a href="${url}" target="_blank"><img src="${url}" alt="${att.name || ''}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
        } else {
          actionLines.push(`<div><a href="${url}" target="_blank">${att.name || url}</a></div>`);
        }
      });
    }
    if (actionLines.length) html += `<div class="popup-section">${actionLines.join('')}</div>`;
    popup.innerHTML = html;
    popup.style.left = (anchorRect.left + window.scrollX + 5) + 'px';
    popup.style.top = (anchorRect.bottom + window.scrollY + 5) + 'px';
    popup.style.display = 'block';

    const viewCalendarBtn = popup.querySelector('.view-calendar-btn');
    if (viewCalendarBtn) {
      viewCalendarBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        try {
          const url = new URL(COMPLETE_URL, window.location.origin);
          const pidValue = viewCalendarBtn.dataset.pid || '';
          if (pidValue) {
            url.searchParams.set('project_id', pidValue);
            url.searchParams.set('highlight', pidValue);
          }
          const projectName = viewCalendarBtn.dataset.project || '';
          if (projectName) {
            const ofMatch = projectName.match(/\bOF\s*(\d{4})\b/i);
            const filterValue = ofMatch ? ofMatch[1] : projectName;
            url.searchParams.set('project', filterValue);
          }
          window.open(url.toString(), '_blank');
        } catch (error) {
          console.error('No se pudo abrir el calendario de planificación:', error);
        }
      });
    }

    const del = document.getElementById('del-btn');
    if (del) {
      del.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('¿Borrar fase?')) {
          fetch(DELETE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ pid: del.dataset.pid, phase: del.dataset.phase })
          }).then(() => location.reload());
        }
      });
    }
    const unplan = document.getElementById('unplan-btn');
    if (unplan) {
      unplan.addEventListener('click', ev => {
        ev.stopPropagation();
        const today = madridDateISO();
        const body = { pid: unplan.dataset.pid, phase: unplan.dataset.phase, date: today, worker: 'Sin planificar' };
        const partValue = normalizePartValue(unplan.dataset.part);
        if (partValue) body.part = partValue;
        fetch(MOVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        })
          .then(resp => resp.json().then(d => ({ ok: resp.ok, data: d })))
          .then(({ ok, data }) => {
            if (!ok) {
              alert(data.error || 'Error');
              return;
            }
            afterMove(data, today);
          });
      });
    }
    const obsSave = document.getElementById('obs-save');
    const obsText = document.getElementById('obs-text');
    if (obsSave && obsText) {
      obsSave.addEventListener('click', ev => {
        ev.stopPropagation();
        const pid = obsSave.dataset.pid;
        const txt = obsText.value;
        const url = OBS_URL_TEMPLATE.replace('__PID__', encodeURIComponent(pid));
        const originalLabel = obsSave.textContent;
        obsSave.disabled = true;
        obsSave.textContent = 'Guardando...';
        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ observations: txt })
        })
          .then(resp => {
            if (resp.ok) {
              return resp.text().catch(() => '');
            }
            return resp.json().catch(() => ({})).then(data => {
              throw new Error(data.error || 'Error guardando observaciones');
            });
          })
          .then(() => {
            if (PROJECT_DATA[pid]) PROJECT_DATA[pid].observations = txt;
            obsSave.textContent = 'Guardado';
            setTimeout(() => { obsSave.textContent = originalLabel; }, 1500);
          })
          .catch(err => {
            alert(err.message || 'Error guardando observaciones');
            obsSave.textContent = originalLabel;
          })
          .finally(() => {
            obsSave.disabled = false;
          });
      });
    }
    const splitBtn = document.getElementById('split-btn');
    if (splitBtn && splitModal) {
      splitBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        splitModal.dataset.pid = splitBtn.dataset.pid;
        splitModal.dataset.phase = splitBtn.dataset.phase;
        splitModal.dataset.date = splitBtn.dataset.date;
        prepareSplitModal(splitBtn);
        splitModal.style.display = 'block';
      });
    }
    const unsplitBtn = document.getElementById('unsplit-btn');
    if (unsplitBtn) {
      unsplitBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('¿Deshacer división de esta fase?')) {
          fetch(UNSPLIT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ pid: unsplitBtn.dataset.pid, phase: unsplitBtn.dataset.phase })
          }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
        }
      });
    }
    const freeze = document.getElementById('freeze-btn');
    if (freeze) {
      freeze.addEventListener('click', ev => {
        ev.stopPropagation();
        fetch('/toggle_freeze/' + freeze.dataset.pid + '/' + encodeURIComponent(freeze.dataset.phase), { method: 'POST', credentials: 'same-origin' })
          .then(() => location.reload());
      });
    }
    const startForm = document.getElementById('start-form');
    if (startForm) {
      startForm.addEventListener('submit', ev => {
        ev.preventDefault();
        ev.stopPropagation();
        const btn = document.getElementById('start-btn');
        const val = document.getElementById('start-input').value;
        fetch(START_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ pid: btn.dataset.pid, phase: btn.dataset.phase, date: val })
        }).then(resp => {
          if (!resp.ok) {
            return resp.json().then(d => { alert(d.error || 'Error'); return null; });
          }
          return resp.json();
        }).then(d => {
          if (d) {
            localStorage.setItem(LAST_KEY, JSON.stringify({pid: btn.dataset.pid, phase: btn.dataset.phase, date: d.date}));
            if (d.date !== val) localStorage.setItem(SCROLL_KEY2, d.date);
          }
          location.reload();
        });
      });
    }
    const hoursForm = document.getElementById('phase-hours-form');
    if (hoursForm) {
      hoursForm.addEventListener('submit', ev => {
        ev.preventDefault();
        ev.stopPropagation();
        const btn = hoursForm.querySelector('button');
        const val = document.getElementById('phase-hours-input').value;
        const payload = { pid: btn.dataset.pid, phase: btn.dataset.phase, hours: val };
        const partValue = normalizePartValue(btn.dataset.part);
        if (partValue) {
          payload.part = partValue;
        }
        fetch(PHASE_HOURS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        }).then(resp => {
          if (resp.ok) {
            const url = new URL(location);
            url.searchParams.set('highlight', btn.dataset.pid);
            location.href = url;
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
      });
    }
  }
  const cells = document.querySelectorAll('.pedidos-calendar td:not(.week-label):not(.unconfirmed)');
  let maxH = 0;
  cells.forEach(c => { if (c.offsetHeight > maxH) maxH = c.offsetHeight; });
  cells.forEach(c => c.style.height = maxH + 'px');

  let dragged = null;
  const tasks = document.querySelectorAll('.pedidos-calendar .task');
  tasks.forEach(t => {
    t.addEventListener('dragstart', e => {
      dragged = t;
      const partValue = normalizePartValue(t.dataset.part);
      const data = {
        pid: t.dataset.pid,
        phase: t.dataset.phase,
        part: partValue || null,
        worker: t.dataset.worker,
        cid: t.dataset.cid
      };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify(data));
    });
    t.addEventListener('dragend', () => { dragged = null; });
  });

  const dayCells = document.querySelectorAll('.pedidos-calendar td[data-date]');
  dayCells.forEach(cell => {
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.pid) {
        fetch("{{ url_for('move_phase') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({pid: data.pid, phase: data.phase, date: cell.dataset.date, worker: data.worker, part: data.part})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: cell.dataset.date})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        cell.appendChild(dragged);
        dragged = null;
      }
    });
  });

  const unconfirmedCell = document.querySelector('.pedidos-calendar td.unconfirmed');
  if (unconfirmedCell) {
    unconfirmedCell.addEventListener('dragover', e => e.preventDefault());
    unconfirmedCell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: null})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        unconfirmedCell.appendChild(dragged);
        dragged = null;
      }
    });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'a' || e.key === 'A') {
      const todayCell = document.querySelector('.pedidos-calendar td.today');
      if (todayCell) {
        todayCell.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    }
  });

  function normalizeFilterValue(value) {
    return (value === undefined || value === null) ? '' : `${value}`.toLowerCase();
  }

  function elementTextIncludes(element, query) {
    if (!query) return true;
    if (!element) return false;
    return element.textContent.toLowerCase().includes(query);
  }

  const filterInput = document.getElementById('filter-input');
  filterInput.addEventListener('input', () => {
    const q = normalizeFilterValue(filterInput.value.trim());
    document.querySelectorAll('.pedidos-calendar .task').forEach(t => {
      const proj = normalizeFilterValue(t.dataset.project);
      const cli = normalizeFilterValue(t.dataset.client);
      const code = normalizeFilterValue(t.dataset.code);
      const text = normalizeFilterValue(t.textContent);
      const showTask = !q || proj.includes(q) || cli.includes(q) || code.includes(q) || text.includes(q);
      t.style.display = showTask ? '' : 'none';
    });
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const proj = normalizeFilterValue(row.dataset.project);
      const title = normalizeFilterValue(row.dataset.title);
      const cli = normalizeFilterValue(row.dataset.client);
      const display = normalizeFilterValue(row.dataset.display);
      const code = normalizeFilterValue(row.dataset.code);
      const rowTextMatches = elementTextIncludes(row, q);
      let linkMatches = false;
      if (q) {
        linkMatches = Array.from(row.querySelectorAll('.link-title')).some(link => {
          const linkTitle = normalizeFilterValue(link.dataset.title);
          const linkLane = normalizeFilterValue(link.dataset.lane);
          const linkColumn = normalizeFilterValue(link.dataset.column);
          const linkText = normalizeFilterValue(link.textContent);
          return linkTitle.includes(q) || linkLane.includes(q) || linkColumn.includes(q) || linkText.includes(q);
        });
      }
      const show = !q || proj.includes(q) || cli.includes(q) || title.includes(q) || display.includes(q) || code.includes(q) || rowTextMatches || linkMatches;
      row.style.display = show ? '' : 'none';
    });
  });

  if (filterInput && initialFilterValue !== null) {
    filterInput.value = initialFilterValue;
    filterInput.dispatchEvent(new Event('input'));
  }

  function parseISODateParts(value) {
    const match = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(value || '');
    if (!match) return null;
    const year = Number(match[1]);
    const month = Number(match[2]) - 1;
    const day = Number(match[3]);
    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) return null;
    return { year, month, day };
  }

  function diffInDays(later, earlier) {
    const laterParts = parseISODateParts(later);
    const earlierParts = parseISODateParts(earlier);
    if (!laterParts || !earlierParts) return null;
    const laterUtc = Date.UTC(laterParts.year, laterParts.month, laterParts.day);
    const earlierUtc = Date.UTC(earlierParts.year, earlierParts.month, earlierParts.day);
    return Math.round((laterUtc - earlierUtc) / 86400000);
  }

  function normalizeDateToIso(value) {
    if (!value) return '';
    if (value instanceof Date) {
      return value.toISOString().slice(0, 10);
    }
    const text = `${value}`.trim();
    if (!text) return '';
    const isoMatch = text.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (isoMatch) {
      return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;
    }
    const euroMatch = text.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (euroMatch) {
      return `${euroMatch[3]}-${euroMatch[2]}-${euroMatch[1]}`;
    }
    return '';
  }

  function formatDueDisplay(value) {
    const parts = parseISODateParts(value);
    if (!parts) return '';
    const day = String(parts.day).padStart(2, '0');
    const month = String(parts.month + 1).padStart(2, '0');
    const year = String(parts.year);
    return `${day}/${month}/${year}`;
  }

  function buildTaskMap() {
    const map = new Map();
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      if (!title) return;
      if (!map.has(title)) map.set(title, []);
      map.get(title).push(task);
    });
    return map;
  }

  function updateDueWarnings() {
    const taskMap = buildTaskMap();
    const dueLateTitles = new Set();
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const planStart = row.dataset.plan || '';
      const projectDue = row.dataset.due || '';
      row.querySelectorAll('.link-title').forEach(link => {
        const title = link.dataset.title;
        const tasks = taskMap.get(title) || [];
        const calendarDates = tasks
          .map(t => t.dataset.due)
          .filter(Boolean)
          .sort();
        let referenceDate = '';
        if (calendarDates.length) {
          referenceDate = calendarDates[0];
        } else if (projectDue) {
          referenceDate = projectDue;
        }
        let isLate = false;
        if (planStart && referenceDate) {
          const diff = diffInDays(referenceDate, planStart);
          if (diff !== null && Math.abs(diff) <= 3) {
            isLate = true;
            dueLateTitles.add(title);
          }
        }
        link.classList.toggle('due-late', isLate);
      });
    });
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      task.classList.toggle('due-late', dueLateTitles.has(title));
    });
  }

  let columnResizeState = null;
  let columnResizeCols = [];
  let columnResizeHeaders = [];
  let columnResizeListenersAttached = false;

  function getColumnResizeClientX(event) {
    if (event.touches && event.touches.length) {
      return event.touches[0].clientX;
    }
    if (event.changedTouches && event.changedTouches.length) {
      return event.changedTouches[0].clientX;
    }
    return event.clientX;
  }

  function applyStoredColumnWidths(cols, headers, table) {
    let stored = null;
    try {
      stored = JSON.parse(localStorage.getItem(COLUMN_WIDTHS_KEY));
    } catch (err) {
      stored = null;
    }

    const widths = cols.map((col, index) => {
      const storedWidth = stored && Array.isArray(stored) ? Number(stored[index]) : NaN;
      if (Number.isFinite(storedWidth) && storedWidth > 0) {
        return storedWidth;
      }
      const defaultWidth = Number(col.dataset.defaultWidth);
      if (Number.isFinite(defaultWidth) && defaultWidth > 0) {
        return defaultWidth;
      }
      const header = headers[index];
      if (header) {
        const headerWidth = header.getBoundingClientRect().width;
        if (Number.isFinite(headerWidth) && headerWidth > 0) {
          return headerWidth;
        }
      }
      return null;
    });

    const wrapper = table ? table.parentElement : null;
    const available = wrapper ? wrapper.getBoundingClientRect().width : (table ? table.getBoundingClientRect().width : 0);
    if (available > 0) {
      const total = widths.reduce((sum, value) => sum + (Number.isFinite(value) && value > 0 ? value : 0), 0);
      if (total > 0 && total > available) {
        const minAllowed = 80 * cols.length;
        const target = Math.max(minAllowed, available);
        const scale = target / total;
        widths.forEach((value, index) => {
          if (Number.isFinite(value) && value > 0) {
            widths[index] = Math.max(80, Math.floor(value * scale));
          }
        });
      }
    }

    cols.forEach((col, index) => {
      const width = widths[index];
      if (Number.isFinite(width) && width > 0) {
        col.style.width = `${width}px`;
      } else {
        col.style.removeProperty('width');
      }
    });
  }

  function getColumnWidth(index) {
    const col = columnResizeCols[index];
    if (!col) return 0;
    const width = parseFloat(col.style.width);
    if (Number.isFinite(width) && width > 0) return width;
    const header = columnResizeHeaders[index];
    if (!header) return 0;
    return header.getBoundingClientRect().width;
  }

  function startColumnResize(event, index) {
    const col = columnResizeCols[index];
    const header = columnResizeHeaders[index];
    if (!col || !header) return;
    event.preventDefault();
    const startWidth = getColumnWidth(index);
    columnResizeState = {
      index,
      startX: getColumnResizeClientX(event),
      startWidth,
    };
    document.body.classList.add('columna-1-resizing');
  }

  function handleColumnResizeMove(event) {
    if (!columnResizeState) return;
    event.preventDefault();
    const currentX = getColumnResizeClientX(event);
    const delta = currentX - columnResizeState.startX;
    const newWidth = Math.max(80, columnResizeState.startWidth + delta);
    const col = columnResizeCols[columnResizeState.index];
    if (col) {
      col.style.width = `${newWidth}px`;
    }
  }

  function finishColumnResize() {
    if (!columnResizeState) return;
    document.body.classList.remove('columna-1-resizing');
    const widths = columnResizeCols.map((col, index) => {
      const width = parseFloat(col.style.width);
      if (Number.isFinite(width) && width > 0) return width;
      const header = columnResizeHeaders[index];
      return header ? header.getBoundingClientRect().width : null;
    });
    localStorage.setItem(COLUMN_WIDTHS_KEY, JSON.stringify(widths));
    columnResizeState = null;
  }

  function initColumnResizing() {
    const table = document.querySelector('.columna-1-table');
    if (!table) return;
    const colgroup = table.querySelector('colgroup');
    if (!colgroup) return;

    columnResizeCols = Array.from(colgroup.children);
    columnResizeHeaders = Array.from(table.querySelectorAll('thead th'));

    applyStoredColumnWidths(columnResizeCols, columnResizeHeaders, table);

    columnResizeHeaders.forEach((th, index) => {
      if (th.querySelector('.col-resize-handle')) return;
      const handle = document.createElement('span');
      handle.className = 'col-resize-handle';
      handle.addEventListener('mousedown', event => startColumnResize(event, index));
      handle.addEventListener('touchstart', event => startColumnResize(event, index), { passive: false });
      th.appendChild(handle);
    });

    if (!columnResizeListenersAttached) {
      document.addEventListener('mousemove', handleColumnResizeMove);
      document.addEventListener('mouseup', finishColumnResize);
      document.addEventListener('touchmove', handleColumnResizeMove, { passive: false });
      document.addEventListener('touchend', finishColumnResize);
      document.addEventListener('touchcancel', finishColumnResize);
      columnResizeListenersAttached = true;
    }
  }

  let currentHighlightState = null;
  let currentHighlightKey = null;

  function normalizeSelection(selection) {
    if (!selection) return null;
    if (typeof selection === 'string') {
      selection = { titles: [selection] };
    } else if (Array.isArray(selection)) {
      selection = { titles: selection };
    } else {
      selection = { ...selection };
    }

    const titles = [];
    if (selection.title) titles.push(selection.title);
    if (Array.isArray(selection.titles)) titles.push(...selection.titles);
    const normTitles = new Set();
    titles.forEach(value => {
      const key = norm(value);
      if (key) normTitles.add(key);
    });
    if (!normTitles.size) return null;

    let laneKeys = null;
    if (selection.lane) {
      const laneKey = norm(selection.lane);
      if (laneKey) {
        laneKeys = new Set([laneKey]);
      }
    }
    if (selection.lanes) {
      if (!laneKeys) laneKeys = new Set();
      for (const lane of selection.lanes) {
        const laneKey = norm(lane);
        if (laneKey) laneKeys.add(laneKey);
      }
      if (!laneKeys.size) laneKeys = null;
    }

    const key = JSON.stringify({
      titles: Array.from(normTitles).sort(),
      lanes: laneKeys ? Array.from(laneKeys).sort() : null,
    });

    return { titleKeys: normTitles, laneKeys, key };
  }

  function applyHighlight(state) {
    const wrapper = document.querySelector('.pedidos-wrapper');
    const tasks = document.querySelectorAll('.pedidos-wrapper .task');
    const links = document.querySelectorAll('.columna-1 .link-title');
    const projectRows = document.querySelectorAll('.columna-1 .project-row');
    tasks.forEach(t => {
      t.classList.remove('highlight');
      t.classList.remove('dimmed');
    });
    links.forEach(l => {
      l.classList.remove('highlight');
      l.classList.remove('dimmed');
    });
    projectRows.forEach(row => {
      row.classList.remove('highlight');
      row.classList.remove('dimmed');
    });
    if (wrapper) {
      wrapper.classList.toggle('highlight-active', !!state);
    }
    if (!state) return;

    const highlightedRows = new Set();

    tasks.forEach(t => {
      const titleKey = norm(t.dataset.title);
      const laneKey = norm(t.dataset.lane);
      if (state.titleKeys.has(titleKey) && (!state.laneKeys || state.laneKeys.has(laneKey))) {
        t.classList.add('highlight');
      } else {
        t.classList.add('dimmed');
      }
    });
    links.forEach(l => {
      const titleKey = norm(l.dataset.title);
      const laneKey = norm(l.dataset.lane);
      if (state.titleKeys.has(titleKey) && (!state.laneKeys || state.laneKeys.has(laneKey))) {
        l.classList.add('highlight');
        const row = l.closest('.project-row');
        if (row) highlightedRows.add(row);
      } else {
        l.classList.add('dimmed');
      }
    });
    projectRows.forEach(row => {
      if (highlightedRows.has(row)) {
        row.classList.add('highlight');
      } else {
        row.classList.add('dimmed');
      }
    });
  }

  function clearHighlight() {
    applyHighlight(null);
    currentHighlightState = null;
    currentHighlightKey = null;
    clearStartDayHighlight();
  }

  function reapplyHighlight() {
    if (currentHighlightState) {
      applyHighlight(currentHighlightState);
    }
  }

  function toggleHighlight(selection) {
    const state = normalizeSelection(selection);
    if (!state) {
      clearHighlight();
      return;
    }
    if (currentHighlightKey && state.key === currentHighlightKey) {
      clearHighlight();
      return;
    }
    applyHighlight(state);
    currentHighlightState = state;
    currentHighlightKey = state.key;
  }

  function attachHighlightHandlers() {
    const calendar = document.querySelector('.pedidos-calendar');
    if (calendar) {
      calendar.addEventListener('click', e => {
        const t = e.target.closest('.task');
        if (!t) return;
        const title = t.dataset.title;
        if (!title) return;
        toggleHighlight({ titles: [title] });
        if (currentHighlightState && t.dataset.pid) {
          highlightProjectStartByPid(t.dataset.pid);
        } else if (!currentHighlightState) {
          clearStartDayHighlight();
        }
      });
    }
    const column = document.querySelector('.columna-1');
    if (column) {
      column.addEventListener('click', e => {
        const el = e.target.closest('.link-title');
        if (!el) return;
        const title = el.dataset.title;
        if (!title) return;
        const row = el.closest('.project-row');
        toggleHighlight({ titles: [title] });
        if (currentHighlightState && row) {
          highlightProjectStartByRow(row);
        } else if (!currentHighlightState) {
          clearStartDayHighlight();
        }
      });
    }
  }

  attachHighlightHandlers();
  updateDueWarnings();
  initColumnResizing();

  const projectList = document.querySelector('.columna-1');
  document.querySelectorAll('.columna-1 .project-row').forEach(resolveRowPid);
  if (projectList) {
    projectList.addEventListener('click', e => {
      const trigger = e.target.closest('.proj-code, .proj-title');
      if (!trigger) return;
      const row = trigger.closest('.project-row');
      if (!row) return;
      if (trigger.classList.contains('proj-title')) {
        const matchingTitles = Array.from(row.querySelectorAll('.link-title'))
          .filter(link => norm(link.dataset.lane) === 'seguimiento compras')
          .map(link => link.dataset.title)
          .filter(Boolean);
        if (matchingTitles.length) {
          toggleHighlight({ titles: matchingTitles, lane: 'Seguimiento compras' });
        } else {
          clearHighlight();
        }
      }
      highlightProjectStartByRow(row);
      const pid = resolveRowPid(row);
      if (!pid || !PROJECT_DATA[pid]) return;
      e.stopPropagation();
      const rect = trigger.getBoundingClientRect();
      const projectName = row.dataset.project || '';
      openPhasePopup({ pid, project: projectName }, rect);
    });
  }

  if (initialHighlightPid) {
    const highlightRow = Array.from(document.querySelectorAll('.columna-1 .project-row')).find(row => row.dataset.pid === initialHighlightPid);
    if (highlightRow) {
      const highlightTitles = Array.from(highlightRow.querySelectorAll('.link-title')).map(link => link.dataset.title).filter(Boolean);
      if (highlightTitles.length) {
        toggleHighlight({ titles: highlightTitles });
      } else {
        highlightRow.classList.add('highlight');
      }
      highlightProjectStartByRow(highlightRow);
      highlightRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      highlightProjectStartByPid(initialHighlightPid);
    }
    const highlightTasks = Array.from(document.querySelectorAll(`.pedidos-calendar .task[data-pid='${initialHighlightPid}']`));
    if (highlightTasks.length) {
      highlightTasks[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    const updatedUrl = new URL(window.location.href);
    updatedUrl.searchParams.delete('highlight');
    history.replaceState(null, '', updatedUrl);
  }

  const source = new EventSource("{{ url_for('event_stream') }}");
  source.onmessage = () => {
    fetch("{{ url_for('project_links_api') }}")
      .then(r => r.json())
      .then(items => {
        const container = document.querySelector('.columna-1-content');
        if (!container) return;
        container.querySelectorAll('.project-row').forEach(r => r.remove());
        const infoTitleEl = document.getElementById('columna-1-info-title');
        if (infoTitleEl) {
          const infoNames = Array.from(new Set(items.map(item => (item.board || '').trim()).filter(Boolean)));
          if (infoNames.length) {
            const newTitle = infoNames.join(' / ');
            infoTitleEl.textContent = newTitle;
            infoTitleEl.dataset.defaultTitle = newTitle;
          } else {
            infoTitleEl.textContent = infoTitleEl.dataset.defaultTitle || '';
          }
        }

        items.forEach(item => {
          const row = document.createElement('tr');
          row.className = 'project-row';
          row.dataset.pid = item.pid || '';
          const projectValue = (item.project || item.title || '').trim();
          row.dataset.project = projectValue;
          const fullTitle = (item.title || '').trim();
          const resolvedTitle = fullTitle || projectValue;
          row.dataset.title = resolvedTitle;
          row.dataset.client = item.client || '';
          const planValueRaw = item.plan_start || item.montar_start || '';
          const planValue = planValueRaw ? String(planValueRaw).trim() : '';
          row.dataset.plan = planValue;
          row.dataset.due = item.due || '';
          const display = (item.display_title || resolvedTitle || '').trim();
          const code = (item.custom_card_id || '').trim();
          const dueDisplay = formatDueDisplay(item.due);
          const startDisplay = formatDueDisplay(planValue);
          row.dataset.display = display;
          row.dataset.code = code;

          const titleCell = document.createElement('td');
          titleCell.className = 'proj-title-cell';
          if (code) {
            const codeSpan = document.createElement('span');
            codeSpan.className = 'proj-code proj-code-badge';
            codeSpan.dataset.project = projectValue;
            codeSpan.dataset.code = code;
            codeSpan.textContent = code;
            titleCell.appendChild(codeSpan);
          }
          const titleStrong = document.createElement('strong');
          titleStrong.className = 'proj-title';
          titleStrong.dataset.project = projectValue;
          titleStrong.dataset.code = code;
          titleStrong.textContent = resolvedTitle;
          titleCell.appendChild(titleStrong);
          row.appendChild(titleCell);

          const dueCell = document.createElement('td');
          dueCell.className = 'due-cell';
          if (dueDisplay) {
            const dueSpan = document.createElement('span');
            dueSpan.className = 'proj-due';
            dueSpan.textContent = dueDisplay;
            dueCell.appendChild(dueSpan);
          }
          row.appendChild(dueCell);

          const startCell = document.createElement('td');
          startCell.className = 'start-cell';
          if (startDisplay) {
            const startSpan = document.createElement('span');
            startSpan.className = 'proj-start';
            startSpan.textContent = startDisplay;
            startCell.appendChild(startSpan);
          }
          row.appendChild(startCell);

          const orderCell = document.createElement('td');
          orderCell.className = 'order-date-cell';

          const countCell = document.createElement('td');
          countCell.className = 'order-count-cell';

          const linksCell = document.createElement('td');
          linksCell.className = 'links-cell';
          const linkDetails = Array.isArray(item.link_details) ? item.link_details : [];
          const links = Array.isArray(item.links) ? item.links : [];
          links.forEach((link, idx) => {
            const detail = linkDetails[idx] || {};
            const orderDiv = document.createElement('div');
            orderDiv.className = 'order-date-entry';
            const orderValue = detail && detail.order_date ? String(detail.order_date).trim() : '';
            const orderRaw = detail && detail.order_date_raw ? String(detail.order_date_raw).trim() : '';
            if (orderValue) {
              orderDiv.dataset.order = orderValue;
              orderDiv.textContent = formatDueDisplay(orderValue);
              if (!orderDiv.textContent) orderDiv.textContent = orderValue;
            } else if (orderRaw) {
              orderDiv.textContent = orderRaw;
            } else {
              orderDiv.appendChild(document.createTextNode('\u00a0'));
            }
            orderCell.appendChild(orderDiv);

            const countDiv = document.createElement('div');
            countDiv.className = 'order-count-entry';
            const daysValue = detail && detail.order_days;
            const daysNumber = typeof daysValue === 'number' ? daysValue : Number(daysValue);
            if (Number.isFinite(daysNumber)) {
              countDiv.dataset.days = `${daysNumber}`;
              countDiv.textContent = `${daysNumber}`;
            } else {
              countDiv.appendChild(document.createTextNode('\u00a0'));
            }
            countCell.appendChild(countDiv);

            const linkDiv = document.createElement('div');
            linkDiv.className = 'link-title';
            linkDiv.dataset.title = link;
            const laneValue = detail && detail.lane ? detail.lane : '';
            const columnValue = detail && detail.column ? detail.column : '';
            let tooltip = columnValue;
            if (!tooltip && laneValue) {
              tooltip = laneValue;
            } else if (tooltip && laneValue && laneValue !== columnValue) {
              tooltip = `${tooltip} · ${laneValue}`;
            }
            linkDiv.dataset.lane = laneValue;
            linkDiv.dataset.column = columnValue;
            if (tooltip) linkDiv.title = tooltip;
            linkDiv.textContent = link;
            linksCell.appendChild(linkDiv);
          });
          row.appendChild(orderCell);
          row.appendChild(countCell);
          row.appendChild(linksCell);

          resolveRowPid(row);
          container.appendChild(row);
        });
        filterInput.dispatchEvent(new Event('input'));
        reapplyHighlight();
        updateDueWarnings();
      });
  };
});
</script>
{% endblock %}
