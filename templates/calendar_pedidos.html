{% extends 'base.html' %}
{% block content %}
<h2>Calendario pedidos</h2>
<input type="text" id="filter-input" placeholder="Filtrar por título o cliente">
<div class="pedidos-wrapper">
<table class="pedidos-calendar">
    <thead>
    <tr>
        <th>Semana</th>
        <th>Lun</th>
        <th>Mar</th>
        <th>Mié</th>
        <th>Jue</th>
        <th>Vie</th>
        <th rowspan="{{ weeks|length + 1 }}" class="unconfirmed-header">Sin fecha de entrega confirmada</th>
    </tr>
    </thead>
    <tbody>
    {% for week in weeks %}
    <tr>
        <td class="week-label">Semana {{ week.number }}</td>
        {% for d in week.days %}
        <td data-date="{{ d.date.isoformat() }}" class="{% if d.date == today %}today{% endif %}">
            {% if d.month %}<div class="month-divider">{{ d.month }}</div>{% endif %}
            <div class="day-number">{{ d.day }}</div>
            {% for t in d.tasks %}
            <div class="task" draggable="true"
                 data-pid="{{ t.get('pid') or '' }}"
                 data-phase="{{ t.get('phase') or '' }}"
                 data-day="{{ d.date.isoformat() }}"
                 data-worker="{{ t.get('worker') or '' }}"
                 data-cid="{{ t.get('cid') or '' }}"
                 data-project="{{ t.project }}"
                 data-title="{{ t.project }}"
                 data-client="{{ t.get('client') or '' }}"
                 data-due="{{ d.date.isoformat() }}"
                 {% if t.get('part') %}data-part="{{ t.get('part') }}"{% endif %}
                 style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.hours %}
                <span class="task-hours">{% if t.auto %}<span class="auto-hour">{{ t.hours }}h</span>{% else %}{{ t.hours }}h{% endif %}</span>
                {% endif %}
            </div>
            {% endfor %}
        </td>
        {% endfor %}
        {% if loop.first %}
        <td class="unconfirmed" rowspan="{{ weeks|length }}">
            {% for t in unconfirmed %}
              <div class="task" draggable="true"
                   data-pid="{{ t.get('pid') or '' }}"
                   data-phase="{{ t.get('phase') or '' }}"
                   data-worker="{{ t.get('worker') or '' }}"
                   data-cid="{{ t.get('cid') or '' }}"
                   data-project="{{ t.project }}"
                   data-title="{{ t.project }}"
                   data-client="{{ t.get('client') or '' }}"
                   style="border-color: {{ t.get('color', '#999999') }};">
                <span class="task-main">{{ t.project }}</span>
                {% if t.prev_date %}<span class="task-date">({{ t.prev_date }})</span>{% endif %}
                {% if t.hours %}<span class="task-hours">{{ t.hours }}h</span>{% endif %}
            </div>
            {% endfor %}
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
</table>
<div class="columna-1">
    <h3>Columna 1</h3>
    <div class="columna-1-content">
    {% for item in project_links %}
        <div class="project-row" data-project="{{ item.project }}" data-client="{{ item.client }}" data-due="{{ item.due or '' }}" data-montar="{{ item.montar_start or '' }}">
            <span class="proj-name" data-project="{{ item.project }}">{{ item.project }}</span>
            {% if item.client %}
                <span class="proj-client" data-project="{{ item.project }}">{{ item.client }}</span>
            {% endif %}
            {% for link in item.links %}
                <span class="link-title" data-title="{{ link }}">{{ link }}</span>
            {% endfor %}
        </div>
    {% endfor %}
    </div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const cells = document.querySelectorAll('.pedidos-calendar td:not(.week-label):not(.unconfirmed)');
  let maxH = 0;
  cells.forEach(c => { if (c.offsetHeight > maxH) maxH = c.offsetHeight; });
  cells.forEach(c => c.style.height = maxH + 'px');

  let dragged = null;
  const tasks = document.querySelectorAll('.pedidos-calendar .task');
  tasks.forEach(t => {
    t.addEventListener('dragstart', e => {
      dragged = t;
      const data = {
        pid: t.dataset.pid,
        phase: t.dataset.phase,
        part: t.dataset.part,
        worker: t.dataset.worker,
        cid: t.dataset.cid
      };
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify(data));
    });
    t.addEventListener('dragend', () => { dragged = null; });
  });

  const dayCells = document.querySelectorAll('.pedidos-calendar td[data-date]');
  dayCells.forEach(cell => {
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.pid) {
        fetch("{{ url_for('move_phase') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({pid: data.pid, phase: data.phase, date: cell.dataset.date, worker: data.worker, part: data.part})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: cell.dataset.date})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        cell.appendChild(dragged);
        dragged = null;
      }
    });
  });

  const unconfirmedCell = document.querySelector('.pedidos-calendar td.unconfirmed');
  if (unconfirmedCell) {
    unconfirmedCell.addEventListener('dragover', e => e.preventDefault());
    unconfirmedCell.addEventListener('drop', e => {
      e.preventDefault();
      let data;
      try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { data = {}; }
      if (data.cid) {
        fetch("{{ url_for('update_pedido_date') }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify({cid: data.cid, date: null})
        }).then(resp => { if (resp.ok) location.reload(); });
      } else if (dragged) {
        unconfirmedCell.appendChild(dragged);
        dragged = null;
      }
    });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'a' || e.key === 'A') {
      const todayCell = document.querySelector('.pedidos-calendar td.today');
      if (todayCell) {
        todayCell.scrollIntoView({behavior: 'smooth', block: 'center'});
      }
    }
  });

  const filterInput = document.getElementById('filter-input');
  filterInput.addEventListener('input', () => {
    const q = filterInput.value.toLowerCase();
    document.querySelectorAll('.pedidos-calendar .task').forEach(t => {
      const proj = (t.dataset.project || '').toLowerCase();
      const cli = (t.dataset.client || '').toLowerCase();
      t.style.display = (!q || proj.includes(q) || cli.includes(q)) ? '' : 'none';
    });
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const proj = (row.dataset.project || '').toLowerCase();
      const cli = (row.dataset.client || '').toLowerCase();
      const show = (!q || proj.includes(q) || cli.includes(q));
      row.style.display = show ? '' : 'none';
      const next = row.nextElementSibling;
      if (next && next.classList.contains('links-row')) {
        next.style.display = show ? '' : 'none';
      }
    });
  });

  let currentHighlight = null;

  function parseISODateParts(value) {
    const match = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(value || '');
    if (!match) return null;
    const year = Number(match[1]);
    const month = Number(match[2]) - 1;
    const day = Number(match[3]);
    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) return null;
    return { year, month, day };
  }

  function diffInDays(later, earlier) {
    const laterParts = parseISODateParts(later);
    const earlierParts = parseISODateParts(earlier);
    if (!laterParts || !earlierParts) return null;
    const laterUtc = Date.UTC(laterParts.year, laterParts.month, laterParts.day);
    const earlierUtc = Date.UTC(earlierParts.year, earlierParts.month, earlierParts.day);
    return Math.round((laterUtc - earlierUtc) / 86400000);
  }

  function buildTaskMap() {
    const map = new Map();
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      if (!title) return;
      if (!map.has(title)) map.set(title, []);
      map.get(title).push(task);
    });
    return map;
  }

  function updateDueWarnings() {
    const taskMap = buildTaskMap();
    const dueLateTitles = new Set();
    document.querySelectorAll('.columna-1 .project-row').forEach(row => {
      const montarStart = row.dataset.montar || '';
      const projectDue = row.dataset.due || '';
      row.querySelectorAll('.link-title').forEach(link => {
        const title = link.dataset.title;
        const tasks = taskMap.get(title) || [];
        const calendarDates = tasks
          .map(t => t.dataset.due)
          .filter(Boolean)
          .sort();
        let referenceDate = '';
        if (calendarDates.length) {
          referenceDate = calendarDates[0];
        } else if (projectDue) {
          referenceDate = projectDue;
        }
        let isLate = false;
        if (montarStart && referenceDate) {
          const diff = diffInDays(referenceDate, montarStart);
          if (diff !== null && diff <= 3) {
            isLate = true;
            dueLateTitles.add(title);
          }
        }
        link.classList.toggle('due-late', isLate);
      });
    });
    document.querySelectorAll('.pedidos-calendar .task').forEach(task => {
      const title = task.dataset.title;
      task.classList.toggle('due-late', dueLateTitles.has(title));
    });
  }

  function setHighlight(title) {
    const tasks = document.querySelectorAll('.pedidos-calendar .task');
    const links = document.querySelectorAll('.columna-1 .link-title');
    tasks.forEach(t => t.classList.remove('highlight'));
    links.forEach(l => l.classList.remove('highlight'));
    if (title) {
      tasks.forEach(t => { if (t.dataset.title === title) t.classList.add('highlight'); });
      links.forEach(l => { if (l.dataset.title === title) l.classList.add('highlight'); });
      currentHighlight = title;
    } else {
      currentHighlight = null;
    }
  }

  function attachHighlightHandlers() {
    document.querySelector('.pedidos-calendar').addEventListener('click', e => {
      const t = e.target.closest('.task');
      if (!t) return;
      const title = t.dataset.title;
      setHighlight(currentHighlight === title ? null : title);
    });
    document.querySelector('.columna-1').addEventListener('click', e => {
      const el = e.target.closest('.link-title');
      if (!el) return;
      const title = el.dataset.title;
      setHighlight(currentHighlight === title ? null : title);
    });
  }

  attachHighlightHandlers();
  updateDueWarnings();

  const source = new EventSource("{{ url_for('event_stream') }}");
  source.onmessage = () => {
    fetch("{{ url_for('project_links_api') }}")
      .then(r => r.json())
      .then(items => {
        const container = document.querySelector('.columna-1-content');
        container.querySelectorAll('.project-row').forEach(r => r.remove());
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'project-row';
          div.dataset.project = item.project;
          div.dataset.client = item.client || '';
          div.dataset.montar = item.montar_start || '';
          div.dataset.due = item.due || '';
          let html = `<span class="proj-name" data-project="${item.project}">${item.project}</span>`;
          if (item.client) {
            html += `<span class="proj-client" data-project="${item.project}">${item.client}</span>`;
          }
          item.links.forEach(link => {
            html += `<span class="link-title" data-title="${link}">${link}</span>`;
          });
          div.innerHTML = html;
          container.appendChild(div);
        });
        filterInput.dispatchEvent(new Event('input'));
        if (currentHighlight) setHighlight(currentHighlight);
        updateDueWarnings();
      });
  };
});
</script>
{% endblock %}
