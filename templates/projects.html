{% extends 'base.html' %}
{% block content %}
<h2>Proyectos</h2>
<form method="get" class="controls">
    <label>Proyecto: <input type="text" name="project" value="{{ project_filter }}"></label>
    <label>Cliente: <input type="text" name="client" value="{{ client_filter }}"></label>
    <label>Ordenar:
        <select name="sort">
            <option value="created" {% if sort_option == 'created' %}selected{% endif %}>Creación</option>
            <option value="name" {% if sort_option == 'name' %}selected{% endif %}>Nombre</option>
        </select>
    </label>
    <button type="submit">Filtrar</button>
</form>
<table class="projects-table">
    <thead>
    <tr>
        <th>Nombre</th>
        <th>Cliente</th>
        <th>Fecha inicio</th>
        <th>Fecha límite</th>
        <th>Fecha material confirmado</th>
        <th>En plazo</th>
        <th>Planificado</th>
        <th>Origen</th>
        <th>Color</th>
        {% for ph in phases if ph not in ['dibujo', 'pedidos'] %}
            <th>{{ ph }}</th>
        {% endfor %}
        <th>Imagen</th>
        <th></th>
        <th>Actualizar</th>
    </tr>
    </thead>
    <tbody>
    {% for p in projects %}
    <tr data-pid="{{ p.id }}" class="{% if p.frozen_tasks %}frozen{% endif %}" style="background-color: {{ p.color }};">
        <td>{{ p.name }}{% if p.blocked %}<span class="blocked-sign">&#128683;</span>{% endif %}</td>
        <td>{{ p.client }}</td>
        <td>
            {{ p.start_date }}
            <form class="proj-start-form" method="post" action="{{ url_for('update_start_date') }}">
                <input type="hidden" name="pid" value="{{ p.id }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <input type="date" name="start_date" value="{{ p.start_date }}">
            </form>
        </td>
        <td>{{ p.due_date }}
            <form class="due-form" method="post" action="{{ url_for('update_due_date') }}">
                <input type="hidden" name="pid" value="{{ p.id }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <input type="date" name="due_date" value="{{ p.due_date }}">
            </form>
        </td>
        <td>{{ p.material_confirmed_date }}</td>
        <td>
            {% if p.met %}
                <span class="ok">&#10004;</span>
            {% else %}
                <span class="late">&#10060;</span>
            {% endif %}
        </td>
        <td class="plan-col">
            {% if p.plan_state == 'all' %}
                <span class="ok">&#9679;</span>
            {% elif p.plan_state == 'partial' %}
                <span class="unplanned">&#9679;</span>
            {% else %}
                <span class="late">&#9679;</span>
            {% endif %}
        </td>
        <td>{{ 'API' if p.source == 'api' else 'Manual' }}</td>
        <td>
            <select class="color-select" style="display:none">
                {% for c in palette %}
                    <option value="{{ c }}" {% if p.color == c %}selected{% endif %} style="background-color: {{ c }};">{{ c }}</option>
                {% endfor %}
            </select>
        </td>
        {% for ph in phases if ph not in ['dibujo', 'pedidos'] %}
            <td>
            {% set val = p.phases.get(ph, 0) %}
            {% set auto = p.auto_hours.get(ph) if p.auto_hours else False %}
            {% if val is sequence %}
                {% set total = val|map('int')|sum %}
                {% if auto %}<span class="auto-hour">{{ total }}h</span>{% else %}{{ total }}h{% endif %}<br>
            {% else %}
                {% set total = val|int %}
                {% if auto %}<span class="auto-hour">{{ total }}h</span>{% else %}{{ total }}h{% endif %}<br>
            {% endif %}
                <form method="post" action="{{ url_for('update_worker', pid=p.id, phase=ph) }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    {% set assigned = p.assigned.get(ph) if p.assigned and p.assigned.get(ph) else 'Sin planificar' %}
                    <select name="worker">
                        {% for w in all_workers %}
                            <option value="{{ w }}" {% if assigned == w %}selected{% endif %}>{{ w }}</option>
                        {% endfor %}
                    </select>
                </form>
                <form class="phase-hours-form" method="post" action="{{ url_for('update_phase_hours') }}">
                    <input type="hidden" name="pid" value="{{ p.id }}">
                    <input type="hidden" name="phase" value="{{ ph }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    <input type="number" name="hours" value="{{ val|map('int')|sum if val is sequence else (val|int) }}" min="1">
                </form>
                <form class="start-form" method="post" action="{{ url_for('update_phase_start') }}">
                    <input type="hidden" name="pid" value="{{ p.id }}">
                    <input type="hidden" name="phase" value="{{ ph }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    <input type="date" name="date" value="{{ start_map.get(p.id, {}).get(ph, '') }}">
                </form>
            </td>
        {% endfor %}
        <td>
            {% if p.image %}
                {{ p.image.rsplit('/', 1)[-1] }}
            {% else %}
                &mdash;
            {% endif %}
            <form class="image-form" method="post" enctype="multipart/form-data" action="{{ url_for('update_image', pid=p.id) }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <input type="file" name="image" accept="image/*">
            </form>
        </td>
        <td>
            <form method="post" action="{{ url_for('delete_project', pid=p.id, next=url_for('project_list')) }}" class="delete-form">
                <button class="delete-btn" type="submit">&#10060;</button>
            </form>
        </td>
        <td><button class="row-update-btn">ACTUALIZAR</button></td>
    </tr>
    {% endfor %}
    </tbody>
</table>
<script>
  const START_URL = "{{ url_for('update_phase_start') }}";
  const DUE_URL = "{{ url_for('update_due_date') }}";
  const PROJ_START_URL = "{{ url_for('update_start_date') }}";
  const PHASE_HOURS_URL = "{{ url_for('update_phase_hours') }}";
  const ROW_URL = "{{ url_for('update_project_row') }}";
  document.querySelectorAll('.start-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(START_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.due-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(DUE_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.proj-start-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(PROJ_START_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.phase-hours-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(PHASE_HOURS_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            const url = new URL(location);
            url.searchParams.set('highlight', data.get('pid'));
            location.href = url;
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });

  // Save image immediately when selected
  document.querySelectorAll('.image-form input[type=file]').forEach(inp => {
    inp.addEventListener('change', () => {
      const form = inp.closest('form');
      const fd = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        body: fd,
        credentials: 'same-origin'
      }).then(resp => {
        if (resp.ok) {
          location.reload();
        } else {
          resp.json().then(d => alert(d.error || 'Error'));
        }
      });
    });
  });

  const rows = document.querySelectorAll('.projects-table tbody tr[data-pid]');
  rows.forEach(row => {
    row.addEventListener('click', e => {
      e.stopPropagation();
      const pid = row.dataset.pid;
      rows.forEach(r => {
        if (r.dataset.pid === pid) {
          r.classList.add('proj-highlight');
          r.classList.remove('proj-dim');
          const sel = r.querySelector('.color-select');
          if (sel) sel.style.display = 'inline';
        } else {
          r.classList.add('proj-dim');
          r.classList.remove('proj-highlight');
          const sel = r.querySelector('.color-select');
          if (sel) sel.style.display = 'none';
        }
      });
    });
  });
  document.querySelectorAll('.row-update-btn').forEach(btn => {
    btn.addEventListener('click', ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const row = btn.closest('tr');
      const pid = row.dataset.pid;
      const data = {pid, workers:{}, phases:{}, phase_starts:{}};
      row.querySelectorAll('form:not(.delete-form):not(.image-form)').forEach(f => {
        const fd = new FormData(f);
        if (f.classList.contains('phase-hours-form')) {
          data.phases[fd.get('phase')] = fd.get('hours');
        } else if (f.classList.contains('start-form')) {
          data.phase_starts[fd.get('phase')] = fd.get('date');
        } else if (f.action.includes('update_worker')) {
          const phase = f.action.split('/').pop();
          data.workers[phase] = fd.get('worker');
        } else if (f.classList.contains('proj-start-form')) {
          data.start_date = fd.get('start_date') || fd.get('date');
        } else if (f.classList.contains('due-form')) {
          data.due_date = fd.get('due_date');
        }
      });
      const colorSel = row.querySelector('.color-select');
      if (colorSel) {
        data.color = colorSel.value;
      }
      const imgForm = row.querySelector('.image-form');
      let imgPromise = Promise.resolve();
      if (imgForm) {
        const inp = imgForm.querySelector('input[type=file]');
        if (inp && inp.files.length) {
          const fd = new FormData(imgForm);
          imgPromise = fetch(imgForm.action, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin'
          });
        }
      }
      fetch(ROW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      }).then(resp => {
        if (resp.ok) {
          imgPromise.then(() => {
            const url = new URL(location);
            url.searchParams.set('highlight', pid);
            location.href = url;
          });
        } else {
          resp.json().then(d => alert(d.error || 'Error'));
        }
      });
    });
  });
  document.addEventListener('click', () => {
    rows.forEach(r => {
      r.classList.remove('proj-highlight', 'proj-dim');
      const sel = r.querySelector('.color-select');
      if (sel) sel.style.display = 'none';
    });
  });
</script>
{% endblock %}
