{% extends 'base.html' %}
{% block content %}
<h2>Proyectos</h2>
<form method="get" class="controls">
    <label>Proyecto: <input type="text" name="project" value="{{ project_filter }}"></label>
    <label>Cliente: <input type="text" name="client" value="{{ client_filter }}"></label>
    <label>Ordenar:
        <select name="sort">
            <option value="created" {% if sort_option == 'created' %}selected{% endif %}>Creación</option>
            <option value="name" {% if sort_option == 'name' %}selected{% endif %}>Nombre</option>
        </select>
    </label>
    <button type="submit">Filtrar</button>
</form>
<table class="projects-table">
    <thead>
    <tr>
        <th>Nombre</th>
        <th>Cliente</th>
        <th>Fecha inicio</th>
        <th>Fecha límite</th>
        <th>En plazo</th>
        <th>Planificado</th>
        <th>Origen</th>
        <th>Prioridad</th>
        {% for ph in phases %}
            {% if ph == 'pedidos' %}
                <th>Plazo acopio</th>
            {% else %}
                <th>{{ ph }}</th>
            {% endif %}
        {% endfor %}
        <th>Cambiar</th>
        <th></th>
        <th>Actualizar</th>
    </tr>
    </thead>
    <tbody>
    {% for p in projects %}
    <tr data-pid="{{ p.id }}" class="{% if p.frozen %}frozen{% endif %}" style="background-color: {{ p.color }};">
        <td>{{ p.name }}{% if p.blocked %}<span class="blocked-sign">&#128683;</span>{% endif %}</td>
        <td>{{ p.client }}</td>
        <td>
            {{ p.start_date }}
            <form class="proj-start-form" method="post" action="{{ url_for('update_start_date') }}">
                <input type="hidden" name="pid" value="{{ p.id }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <input type="date" name="start_date" value="{{ p.start_date }}">
            </form>
        </td>
        <td>{{ p.due_date }}
            <form class="due-form" method="post" action="{{ url_for('update_due_date') }}">
                <input type="hidden" name="pid" value="{{ p.id }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <input type="date" name="due_date" value="{{ p.due_date }}">
            </form>
        </td>
        <td>
            {% if p.met %}
                <span class="ok">&#10004;</span>
            {% else %}
                <span class="late">&#10060;</span>
            {% endif %}
        </td>
        <td>
            {% if p.planned %}
                <span class="ok">&#10004;</span>
            {% else %}
                <span class="late">&#10060;</span>
            {% endif %}
        </td>
        <td>{{ p.priority }}</td>
        <td>{{ 'API' if p.source == 'api' else 'Manual' }}</td>
        {% for ph in phases %}
            <td>
            {% set val = p.phases.get(ph, 0) %}
            {% if ph == 'pedidos' %}
                {{ val }}<br>
            {% else %}
                {% if val is sequence %}
                    {{ val|map('int')|sum }}h<br>
                {% else %}
                    {{ val|int }}h<br>
                {% endif %}
            {% endif %}
                <form method="post" action="{{ url_for('update_worker', pid=p.id, phase=ph) }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    <select name="worker">
                        {% for w in all_workers %}
                            <option value="{{ w }}" {% if p.assigned and p.assigned.get(ph) == w %}selected{% endif %}>{{ w }}</option>
                        {% endfor %}
                    </select>
                </form>
                <form class="phase-hours-form" method="post" action="{{ url_for('update_phase_hours') }}">
                    <input type="hidden" name="pid" value="{{ p.id }}">
                    <input type="hidden" name="phase" value="{{ ph }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    <input type="number" name="hours" value="{{ val|map('int')|sum if val is sequence else (val|int) }}" min="1">
                </form>
                <form class="start-form" method="post" action="{{ url_for('update_phase_start') }}">
                    <input type="hidden" name="pid" value="{{ p.id }}">
                    <input type="hidden" name="phase" value="{{ ph }}">
                    <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                    <input type="date" name="date" value="{{ start_map.get(p.id, {}).get(ph, '') }}">
                </form>
            </td>
        {% endfor %}
        <td>
            <form method="post" action="{{ url_for('update_priority', pid=p.id) }}">
                <input type="hidden" name="next" value="{{ url_for('project_list') }}">
                <select name="priority">
                    {% for pr in priorities %}
                        <option value="{{ pr }}" {% if pr == p.priority %}selected{% endif %}>{{ pr }}</option>
                    {% endfor %}
                </select>
            </form>
        </td>
        <td>
            <form method="post" action="{{ url_for('delete_project', pid=p.id, next=url_for('project_list')) }}" class="delete-form">
                <button class="delete-btn" type="submit">&#10060;</button>
            </form>
        </td>
        <td><button class="row-update-btn">ACTUALIZAR</button></td>
    </tr>
    {% endfor %}
    </tbody>
</table>
<script>
  const START_URL = "{{ url_for('update_phase_start') }}";
  const DUE_URL = "{{ url_for('update_due_date') }}";
  const PROJ_START_URL = "{{ url_for('update_start_date') }}";
  const PHASE_HOURS_URL = "{{ url_for('update_phase_hours') }}";
  const ROW_URL = "{{ url_for('update_project_row') }}";
  document.querySelectorAll('.start-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(START_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.due-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(DUE_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.proj-start-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(PROJ_START_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            location.reload();
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });
  document.querySelectorAll('.phase-hours-form').forEach(f => {
    f.addEventListener('submit', ev => {
      ev.preventDefault();
      const data = new FormData(f);
      fetch(PHASE_HOURS_URL, {
        method: 'POST',
        body: data,
        credentials: 'same-origin'
      })
        .then(resp => {
          if (resp.ok) {
            const url = new URL(location);
            url.searchParams.set('highlight', data.get('pid'));
            location.href = url;
          } else {
            resp.json().then(d => alert(d.error || 'Error'));
          }
        });
    });
  });

  const rows = document.querySelectorAll('.projects-table tbody tr[data-pid]');
  rows.forEach(row => {
    row.addEventListener('click', e => {
      e.stopPropagation();
      const pid = row.dataset.pid;
      rows.forEach(r => {
        if (r.dataset.pid === pid) {
          r.classList.add('proj-highlight');
          r.classList.remove('proj-dim');
        } else {
          r.classList.add('proj-dim');
          r.classList.remove('proj-highlight');
        }
      });
    });
  });
  document.querySelectorAll('.row-update-btn').forEach(btn => {
    btn.addEventListener('click', ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const row = btn.closest('tr');
      const pid = row.dataset.pid;
      const data = {pid, workers:{}, phases:{}, phase_starts:{}};
      row.querySelectorAll('form:not(.delete-form)').forEach(f => {
        const fd = new FormData(f);
        if (f.classList.contains('phase-hours-form')) {
          data.phases[fd.get('phase')] = fd.get('hours');
        } else if (f.classList.contains('start-form')) {
          data.phase_starts[fd.get('phase')] = fd.get('date');
        } else if (f.action.includes('update_worker')) {
          const phase = f.action.split('/').pop();
          data.workers[phase] = fd.get('worker');
        } else if (f.classList.contains('proj-start-form')) {
          data.start_date = fd.get('start_date') || fd.get('date');
        } else if (f.classList.contains('due-form')) {
          data.due_date = fd.get('due_date');
        } else if (f.action.includes('update_priority')) {
          data.priority = fd.get('priority');
        }
      });
      fetch(ROW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      }).then(resp => {
        if (resp.ok) {
          const url = new URL(location);
          url.searchParams.set('highlight', pid);
          location.href = url;
        } else {
          resp.json().then(d => alert(d.error || 'Error'));
        }
      });
    });
  });
  document.addEventListener('click', () => {
    rows.forEach(r => r.classList.remove('proj-highlight', 'proj-dim'));
  });
</script>
{% endblock %}
