{% extends "base.html" %}
{% block content %}
<h1>Vista Gantt</h1>
<div class="gantt-controls">
  <button id="expand_all">Desplegar todos</button>
  <button id="collapse_all">Plegar todos</button>
  <button id="zoom_in">+</button>
  <button id="zoom_out">-</button>
  <button id="sort_start">Ordenar por inicio</button>
  <button id="sort_due">Ordenar por l√≠mite</button>
  <button id="go_today">HOY</button>
  <input id="filter_project" type="text" placeholder="Filtrar por proyecto" />
  <input id="filter_client" type="text" placeholder="Filtrar por cliente" />
</div>
<div class="gantt-wrapper">
  <div id="gantt_summary" class="gantt-summary">
    <div class="summary-header">Resumen</div>
    <div id="gantt_summary_body"></div>
    <div id="summary-resizer" class="summary-resizer"></div>
  </div>
  <div id="gantt_main" class="gantt-main">
    <div id="gantt_header" class="gantt-header"></div>
    <div id="gantt_body" class="gantt-body"></div>
  </div>
</div>
<style>
  .gantt-wrapper { display:flex; }
  .gantt-summary { width:250px; overflow-x:hidden; overflow-y:auto; border:1px solid #ddd; border-right:0; height:80vh; position:relative; box-sizing:border-box; }
  .gantt-summary::-webkit-scrollbar { display:none; }
  .gantt-summary { -ms-overflow-style:none; scrollbar-width:none; }
  .summary-header { position:sticky; top:0; background:#fff; border-bottom:1px solid #ddd; text-align:center; height:20px; line-height:20px; font-weight:bold; color:#000; }
  .summary-row { height:30px; line-height:30px; border-bottom:1px solid #ddd; padding:0 4px; box-sizing:border-box; color:#000; white-space:nowrap; }
  .summary-row.project-row { cursor:pointer; font-weight:bold; }
  .summary-row.phase-row { padding-left:16px; opacity:0.5; }
  .gantt-row.phase-row { opacity:0.5; }
  .gantt-main { flex:1; overflow:auto; position:relative; border:1px solid #ddd; -ms-overflow-style:none; scrollbar-width:none; height:80vh; }
  .gantt-main::-webkit-scrollbar { display:none; }
  .gantt-header { position:sticky; top:0; height:20px; border-bottom:1px solid #ddd; background:#fff; }
  .day-cell { position:absolute; top:0; border-right:1px solid #ddd; text-align:center; font-size:12px; color:#000; line-height:20px; box-sizing:border-box; }
  .gantt-body { position:relative; }
  .gantt-row { height:29px; border-bottom:1px solid #ddd; position:relative; }
  .gantt-task { position:absolute; top:0; height:100%; line-height:29px; color:#000; font-size:12px; padding:0 4px; box-sizing:border-box; border-radius:2px; overflow:visible; white-space:nowrap; display:flex; align-items:center; }
  .project-bar { cursor:pointer; }
  .project-bar .deadline-highlight {
    position:absolute;
    top:-2px;
    height:calc(100% + 4px);
    border:3px solid #d00;
    border-radius:4px;
    pointer-events:none;
    box-sizing:border-box;
    font-weight:bold;
    background:transparent;
    z-index:1;
  }
  .day-cell.today { background:transparent; border-left:3px solid #000; border-right:3px solid #000; font-weight:bold; }
  .today-column { position:absolute; top:0; bottom:0; border-left:3px solid #000; border-right:3px solid #000; pointer-events:none; box-sizing:border-box; background:transparent; z-index:2; }
  .deadline-column {
    position:absolute;
    top:0;
    bottom:0;
    border-left:2px solid #d00;
    border-right:2px solid #d00;
    background:rgba(221, 0, 0, 0.12);
    pointer-events:none;
    box-sizing:border-box;
    z-index:0;
  }
  .day-cell.deadline-overdue {
    border-top:2px solid #d00;
    border-bottom:2px solid #d00;
    font-weight:bold;
  }
  .day-cell.deadline-overdue-start { border-left:2px solid #d00; }
  .day-cell.deadline-overdue-end { border-right:2px solid #d00; }
  .day-cell.today.deadline-overdue { border-top:2px solid #d00; border-bottom:2px solid #d00; }
  .gantt-controls input { margin-left:8px; padding:4px; }
</style>
<script>
const allProjects = {{ projects|safe }};
let projects = allProjects.slice();
const summaryContainer = document.getElementById('gantt_summary');
const summaryBody = document.getElementById('gantt_summary_body');
const main = document.getElementById('gantt_main');
const header = document.getElementById('gantt_header');
const body = document.getElementById('gantt_body');
const collapsed = JSON.parse(localStorage.getItem('ganttCollapsed') || '{}');
let zoom = parseFloat(localStorage.getItem('ganttZoom') || '1');
let pxPerDay = 40 * zoom;
let todayIndex = null;
let initialScroll = true;
const BAR_HEIGHT = 30;
let currentSort = localStorage.getItem('ganttSort') || null;

const projectFilterInput = document.getElementById('filter_project');
const clientFilterInput = document.getElementById('filter_client');
const FILTER_PROJECT_KEY = 'ganttFilterProject';
const FILTER_CLIENT_KEY = 'ganttFilterClient';

const savedProjectFilter = localStorage.getItem(FILTER_PROJECT_KEY) || '';
const savedClientFilter = localStorage.getItem(FILTER_CLIENT_KEY) || '';
projectFilterInput.value = savedProjectFilter;
clientFilterInput.value = savedClientFilter;

const summaryResizer = document.getElementById('summary-resizer');
const SUMMARY_WIDTH_KEY = 'ganttSummaryWidth';
const savedSummaryWidth = localStorage.getItem(SUMMARY_WIDTH_KEY);
if(savedSummaryWidth){ summaryContainer.style.width = savedSummaryWidth + 'px'; }
if(summaryResizer){
  let startX, startWidth;
  const onMouseMove = e => {
    const dx = e.clientX - startX;
    const newWidth = Math.max(150, startWidth + dx);
    summaryContainer.style.width = newWidth + 'px';
  };
  const onMouseUp = () => {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    localStorage.setItem(SUMMARY_WIDTH_KEY, summaryContainer.offsetWidth);
  };
  summaryResizer.addEventListener('mousedown', e => {
    startX = e.clientX;
    startWidth = summaryContainer.offsetWidth;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
}

function formatDate(d){return d.split('T')[0];}

function sortProjects(type, store=true){
  if(!type){
    currentSort = null;
    if(store) localStorage.removeItem('ganttSort');
    render();
    return;
  }
  projects.sort((a,b)=>{
    const da = type==='start'? new Date(a.start) : new Date(a.due_date || '9999-12-31');
    const db = type==='start'? new Date(b.start) : new Date(b.due_date || '9999-12-31');
    return da - db;
  });
  currentSort = type;
  if(store) localStorage.setItem('ganttSort', type);
  render();
}

function applyFilters(store=true){
  const projectRaw = projectFilterInput.value.trim();
  const clientRaw = clientFilterInput.value.trim();
  const projectTerm = projectRaw.toLowerCase();
  const clientTerm = clientRaw.toLowerCase();
  if(store){
    if(projectRaw){
      localStorage.setItem(FILTER_PROJECT_KEY, projectRaw);
    } else {
      localStorage.removeItem(FILTER_PROJECT_KEY);
    }
    if(clientRaw){
      localStorage.setItem(FILTER_CLIENT_KEY, clientRaw);
    } else {
      localStorage.removeItem(FILTER_CLIENT_KEY);
    }
  }
  projects = allProjects.filter(p=>{
    const matchesProject = !projectTerm || p.name.toLowerCase().includes(projectTerm);
    const matchesClient = !clientTerm || (p.client || '').toLowerCase().includes(clientTerm);
    return matchesProject && matchesClient;
  });
  if(currentSort){
    sortProjects(currentSort, false);
    return;
  }
  render();
}

function render(){
  summaryBody.innerHTML = '';
  body.innerHTML = '';
  header.innerHTML = '';
  if(!projects.length){return;}
  const dayMs = 24*60*60*1000;
  const startOfDay = d => {
    const raw = (d ?? '').toString().trim();
    if(!raw){
      return new Date(NaN);
    }
    const normalized = raw.replace(' ', 'T');
    const base = normalized.split('T')[0];
    return new Date(base + 'T00:00:00');
  };
  const allStarts = [];
  const allEnds = [];
  const deadlineTimes = [];
  projects.forEach(p=>{
    const ps = startOfDay(p.start);
    const pe = startOfDay(p.end);
    const psMs = ps.getTime();
    const peMs = pe.getTime();
    allStarts.push(psMs);
    allEnds.push(peMs);
    const deadlineRaw = p.deadline_start || p.due_date || p.client_date || p.client_due_date;
    const deadlineDate = startOfDay(deadlineRaw);
    const deadlineMs = deadlineDate.getTime();
    p._deadlineMs = deadlineMs;
    if(!Number.isNaN(deadlineMs) && deadlineMs <= peMs){
      deadlineTimes.push(deadlineMs);
    }
    p.phases.forEach(ph=>{
      const s = startOfDay(ph.start);
      const e = startOfDay(ph.end);
      allStarts.push(s.getTime());
      allEnds.push(e.getTime());
    });
  });
  let minStart = Math.min(...allStarts);
  let maxEnd = Math.max(...allEnds);
  if(deadlineTimes.length){
    minStart = Math.min(minStart, ...deadlineTimes);
    maxEnd = Math.max(maxEnd, ...deadlineTimes);
  }
  const totalDays = Math.round((maxEnd - minStart)/dayMs) + 1;
  pxPerDay = 40 * zoom;
  const width = totalDays * pxPerDay;
  header.style.width = width + 'px';
  body.style.width = width + 'px';
  body.style.background = `repeating-linear-gradient(to right, #ddd, #ddd 1px, transparent 1px, transparent ${pxPerDay}px)`;
  header.style.background = body.style.background;
  const todayStr = new Date().toISOString().split('T')[0];
  todayIndex = null;

  const overdueColumns = new Set();
  projects.forEach(p=>{
    const s = startOfDay(p.start).getTime();
    const e = startOfDay(p.end).getTime();
    const deadlineMs = p._deadlineMs;
    if(Number.isNaN(deadlineMs)) return;
    if(e < deadlineMs) return;
    const rangeStart = Math.max(deadlineMs, s);
    if(rangeStart > e) return;
    const startIdx = Math.max(0, Math.floor((rangeStart - minStart) / dayMs));
    const endIdx = Math.max(startIdx, Math.floor((e - minStart) / dayMs));
    for(let idx = startIdx; idx <= endIdx; idx++){
      overdueColumns.add(idx);
    }
  });

  const overdueStates = new Map();
  const overdueSpans = [];
  const overdueIndices = Array.from(overdueColumns).sort((a,b)=>a-b);
  if(overdueIndices.length){
    let spanStart = overdueIndices[0];
    let prev = spanStart;
    for(let i=1;i<overdueIndices.length;i++){
      const idx = overdueIndices[i];
      if(idx === prev + 1){
        prev = idx;
        continue;
      }
      overdueSpans.push([spanStart, prev]);
      spanStart = idx;
      prev = idx;
    }
    overdueSpans.push([spanStart, prev]);
    overdueSpans.forEach(([startIdx, endIdx])=>{
      for(let i=startIdx;i<=endIdx;i++){
        let state = 'middle';
        if(i === startIdx && i === endIdx){
          state = 'single';
        } else if(i === startIdx){
          state = 'start';
        } else if(i === endIdx){
          state = 'end';
        }
        overdueStates.set(i, state);
      }
    });
  }

  for(let i=0;i<totalDays;i++){
    const d = new Date(minStart + i*dayMs);
    const iso = d.toISOString().split('T')[0];
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.style.left = (i*pxPerDay) + 'px';
    cell.style.width = pxPerDay + 'px';
    cell.textContent = d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'});
    if(iso === todayStr){ cell.classList.add('today'); todayIndex = i; }
    const overdueState = overdueStates.get(i);
    if(overdueState){
      cell.classList.add('deadline-overdue');
      if(overdueState === 'start' || overdueState === 'single'){
        cell.classList.add('deadline-overdue-start');
      }
      if(overdueState === 'end' || overdueState === 'single'){
        cell.classList.add('deadline-overdue-end');
      }
    }
    header.appendChild(cell);
  }

  if(todayIndex !== null){
    const highlight = document.createElement('div');
    highlight.className = 'today-column';
    highlight.style.left = (todayIndex*pxPerDay) + 'px';
    highlight.style.width = pxPerDay + 'px';
    body.appendChild(highlight);
  }

  overdueSpans.forEach(([startIdx, endIdx])=>{
    const column = document.createElement('div');
    column.className = 'deadline-column';
    column.style.left = (startIdx*pxPerDay) + 'px';
    column.style.width = ((endIdx - startIdx + 1) * pxPerDay) + 'px';
    body.appendChild(column);
  });

  const rows = [];
  projects.forEach(p=>{
    rows.push({type:'project', project:p});
    if(!collapsed[p.id]){
      p.phases.forEach(ph=>rows.push({type:'phase', project:p, phase:ph}));
    }
  });

  rows.forEach(r=>{
    const summaryRow = document.createElement('div');
    summaryRow.className = 'summary-row ' + (r.type==='project'?'project-row':'phase-row');
    if(r.type==='project'){
      summaryRow.textContent = `${r.project.name} - ${r.project.client}`;
      summaryRow.onclick = ()=>toggleProject(r.project.id);
    } else {
      summaryRow.textContent = `${r.phase.name}${r.phase.worker ? ' - ' + r.phase.worker : ''}`;
    }
    summaryBody.appendChild(summaryRow);

    const rowDiv = document.createElement('div');
    rowDiv.className = 'gantt-row ' + (r.type==='project'?'project-row':'phase-row');
    const bar = document.createElement('div');
    bar.className = 'gantt-task ' + (r.type==='project'?'project-bar':'phase-bar');
    const s = startOfDay(r.type==='project'?r.project.start:r.phase.start).getTime();
    const e = startOfDay(r.type==='project'?r.project.end:r.phase.end).getTime();
    bar.style.left = ((s - minStart)/dayMs*pxPerDay) + 'px';
    bar.style.width = (((e - s)/dayMs + 1)*pxPerDay) + 'px';
    bar.style.background = r.type==='project'?(r.project.color || '#3a87ad'):(r.phase.color || r.project.color || '#6c9ec1');
    bar.textContent = r.type==='project'?`${r.project.name} - ${r.project.client} (${formatDate(r.project.start)} - ${formatDate(r.project.end)})`:r.phase.name;
    if(r.type==='project'){
      const deadlineRaw = r.project.deadline_start || r.project.due_date || r.project.client_date || r.project.client_due_date;
      const deadlineDate = startOfDay(deadlineRaw);
      const deadlineMs = deadlineDate.getTime();
      if(!Number.isNaN(deadlineMs) && e >= deadlineMs){
        const visibleStart = Math.max(deadlineMs, s);
        const leftPx = ((visibleStart - s)/dayMs) * pxPerDay;
        const widthDays = Math.max(0, Math.round((e - visibleStart)/dayMs)) + 1;
        if(widthDays > 0){
          const highlight = document.createElement('div');
          highlight.className = 'deadline-highlight';
          highlight.style.left = Math.max(0, leftPx) + 'px';
          highlight.style.width = (widthDays * pxPerDay) + 'px';
          bar.appendChild(highlight);
        }
      }
      bar.onclick = ()=>toggleProject(r.project.id);
    }
    rowDiv.appendChild(bar);
    body.appendChild(rowDiv);
  });

  const totalHeight = rows.length * BAR_HEIGHT;
  summaryBody.style.height = totalHeight + 'px';
    body.style.height = totalHeight + 'px';
  if(initialScroll){ scrollToToday(); initialScroll=false; }
}

function scrollToToday(){
  if(todayIndex === null) return;
  main.scrollLeft = todayIndex * pxPerDay - main.clientWidth/2 + pxPerDay/2;
}

function toggleProject(id){
  collapsed[id] = !collapsed[id];
  localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed));
  render();
}

document.getElementById('expand_all').onclick = ()=>{projects.forEach(p=>collapsed[p.id]=false); localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed)); render();};
document.getElementById('collapse_all').onclick = ()=>{projects.forEach(p=>collapsed[p.id]=true); localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed)); render();};
document.getElementById('zoom_in').onclick = ()=>{zoom*=1.25; localStorage.setItem('ganttZoom', zoom); render();};
document.getElementById('zoom_out').onclick = ()=>{zoom/=1.25; localStorage.setItem('ganttZoom', zoom); render();};
document.getElementById('sort_start').onclick = ()=>sortProjects('start');
document.getElementById('sort_due').onclick = ()=>sortProjects('due');
document.getElementById('go_today').onclick = scrollToToday;
projectFilterInput.addEventListener('input', ()=>applyFilters());
clientFilterInput.addEventListener('input', ()=>applyFilters());

let syncing = false;
function syncScroll(source, target){
  if(syncing) return;
  syncing = true;
  target.scrollTop = source.scrollTop;
  syncing = false;
}

main.addEventListener('scroll',()=>syncScroll(main, summaryContainer));
summaryContainer.addEventListener('scroll',()=>syncScroll(summaryContainer, main));
applyFilters(false);
</script>
{% endblock %}
