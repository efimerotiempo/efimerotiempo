{% extends "base.html" %}
{% block content %}
<h1>Vista Gantt</h1>
<div class="gantt-controls">
  <button id="expand_all">Desplegar todos</button>
  <button id="collapse_all">Plegar todos</button>
  <button id="zoom_in">+</button>
  <button id="zoom_out">-</button>
  <button id="sort_start">Ordenar por inicio</button>
  <button id="sort_due">Ordenar por límite</button>
  <button id="go_today">HOY</button>
  <input id="filter_project" type="text" placeholder="Filtrar por proyecto" />
  <input id="filter_client" type="text" placeholder="Filtrar por cliente" />
</div>
<div class="gantt-wrapper">
  <div id="gantt_summary" class="gantt-summary">
    <div id="gantt_summary_header" class="summary-header-row summary-grid"></div>
    <div id="gantt_summary_body" class="summary-body"></div>
    <div id="summary-resizer" class="summary-resizer"></div>
  </div>
  <div id="gantt_main" class="gantt-main">
    <div id="gantt_header" class="gantt-header"></div>
    <div id="gantt_body" class="gantt-body"></div>
  </div>
</div>
<div id="info-popup" class="info-popup"></div>
<div id="deadline-modal" class="conflict-modal">
  <div class="conflict-content">
    <div id="deadline-text" style="color:orange;font-weight:bold"></div>
    <button id="deadline-close">Cerrar</button>
  </div>
</div>
<div id="split-modal" class="conflict-modal">
  <div class="conflict-content">
    <form id="split-form">
      <label>Horas primera parte: <input type="number" id="split-part1" min="0" required></label><br>
      <label>Horas segunda parte: <input type="number" id="split-part2" min="0" required></label><br>
      <button type="submit">Aceptar</button>
      <button type="button" id="split-cancel">Cancelar</button>
    </form>
  </div>
</div>
<div id="obs-modal" class="modal">
  <div class="modal-content">
    <textarea id="obs-text" style="width:100%;height:100px;"></textarea><br>
    <button id="obs-save" type="button">Guardar</button>
    <button id="obs-cancel" type="button">Cancelar</button>
  </div>
</div>
<style>
  .gantt-wrapper { display:flex; }
  .gantt-summary { width:600px; min-width:360px; overflow-x:auto; overflow-y:auto; border:1px solid #ddd; border-right:0; height:80vh; position:relative; box-sizing:border-box; --summary-grid: 1fr; }
  .gantt-summary::-webkit-scrollbar { display:none; }
  .gantt-summary { -ms-overflow-style:none; scrollbar-width:none; }
  .summary-grid { display:grid; grid-template-columns: var(--summary-grid); }
  .summary-header-row { position:sticky; top:0; background:#fff; border-bottom:1px solid #ddd; color:#000; z-index:2; }
  .summary-header-row .summary-cell { font-weight:bold; line-height:1.2; padding:4px 8px; white-space:normal; }
  .summary-body { position:relative; }
  .summary-row { height:30px; border-bottom:1px solid #ddd; color:#000; }
  .summary-row.project-row { font-weight:bold; }
  .summary-cell { position:relative; padding:0 8px; display:flex; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-sizing:border-box; }
  .summary-text.project { cursor:pointer; }
  .summary-text.phase { font-weight:normal; padding-left:16px; }
  .summary-row.phase-row .summary-text { opacity:0.75; }
  .summary-col-resizer { position:absolute; top:0; right:-3px; width:6px; cursor:col-resize; height:100%; user-select:none; }
  .summary-col-resizer::after { content:''; position:absolute; top:0; bottom:0; left:2px; width:2px; background:rgba(0,0,0,0.2); }
  .gantt-row.phase-row { opacity:0.5; }
  .gantt-main { flex:1; overflow:auto; position:relative; border:1px solid #ddd; -ms-overflow-style:none; scrollbar-width:none; height:80vh; }
  .gantt-main::-webkit-scrollbar { display:none; }
  .gantt-header { position:sticky; top:0; height:20px; border-bottom:1px solid #ddd; background:#fff; }
  .day-cell { position:absolute; top:0; border-right:1px solid #ddd; text-align:center; font-size:12px; color:#000; line-height:20px; }
  .gantt-body { position:relative; }
  .gantt-row { height:29px; border-bottom:1px solid #ddd; position:relative; }
  .gantt-task { position:absolute; top:0; height:100%; line-height:29px; color:#000; font-size:12px; padding:0 4px; box-sizing:border-box; border-radius:2px; overflow:visible; white-space:nowrap; display:flex; align-items:center; }
  .project-bar { cursor:pointer; }
  .gantt-row .deadline-highlight {
    position:absolute;
    top:-2px;
    height:calc(100% + 4px);
    border:3px solid #d00;
    border-radius:4px;
    pointer-events:none;
    box-sizing:border-box;
    font-weight:bold;
    background:transparent;
    z-index:1;
  }
  .day-cell.today { background-color: rgba(255,0,0,0.3); }
  .today-column { position:absolute; top:0; bottom:0; background-color: rgba(255,0,0,0.1); pointer-events:none; }
  .gantt-controls input { margin-left:8px; padding:4px; }
</style>
<script>
let allProjects = {{ projects|safe }};
let PROJECT_DATA = {{ project_data|tojson }};
let START_DATA = {{ start_map|tojson }};
const PHASES = {{ phases|tojson }};
const STATIC_URL = "{{ url_for('static', filename='') }}";
const MOVE_URL = "{{ url_for('move_phase') }}";
const DELETE_URL = "{{ url_for('delete_phase') }}";
const START_URL = "{{ url_for('update_phase_start') }}";
const SPLIT_URL = "{{ url_for('split_phase_route') }}";
const UNSPLIT_URL = "{{ url_for('unsplit_phase') }}";
const PHASE_HOURS_URL = "{{ url_for('update_phase_hours') }}";
const GANTT_DATA_URL = "{{ url_for('gantt_data_api') }}";
const OBS_URL_TEMPLATE = "{{ url_for('update_observations', pid='__PID__') }}";
const DEADLINE_MSG = 'Fecha cliente soprepasada.';
const CLIENT_DEADLINE_MSG = 'FECHA TOPE SOBREPASADA.';
const LAST_KEY = 'lastMoved';
const SCROLL_KEY2 = 'scrollDate';
let projects = allProjects.slice();
const summaryContainer = document.getElementById('gantt_summary');
const summaryHeaderRow = document.getElementById('gantt_summary_header');
const summaryBody = document.getElementById('gantt_summary_body');
const main = document.getElementById('gantt_main');
const header = document.getElementById('gantt_header');
const body = document.getElementById('gantt_body');
const popup = document.getElementById('info-popup');
const deadlineModal = document.getElementById('deadline-modal');
const deadlineText = document.getElementById('deadline-text');
const deadlineClose = document.getElementById('deadline-close');
const splitModal = document.getElementById('split-modal');
const splitForm = document.getElementById('split-form');
const splitPart1 = document.getElementById('split-part1');
const splitPart2 = document.getElementById('split-part2');
const splitCancel = document.getElementById('split-cancel');
const obsModal = document.getElementById('obs-modal');
const obsText = document.getElementById('obs-text');
const obsSave = document.getElementById('obs-save');
const obsCancel = document.getElementById('obs-cancel');
const collapsed = JSON.parse(localStorage.getItem('ganttCollapsed') || '{}');
let zoom = parseFloat(localStorage.getItem('ganttZoom') || '1');
let pxPerDay = 40 * zoom;
let todayIndex = null;
let initialScroll = true;
const BAR_HEIGHT = 30;
let currentSort = localStorage.getItem('ganttSort') || null;
const DAY_MS = 24*60*60*1000;
let timelineMinStart = null;
let timelinePxPerDay = pxPerDay;

const projectFilterInput = document.getElementById('filter_project');
const clientFilterInput = document.getElementById('filter_client');
const FILTER_PROJECT_KEY = 'ganttFilterProject';
const FILTER_CLIENT_KEY = 'ganttFilterClient';

const savedProjectFilter = localStorage.getItem(FILTER_PROJECT_KEY) || '';
const savedClientFilter = localStorage.getItem(FILTER_CLIENT_KEY) || '';
projectFilterInput.value = savedProjectFilter;
clientFilterInput.value = savedClientFilter;

const SUMMARY_COLUMN_DEFS = [
  { key: 'due_date', label: 'Fecha límite', defaultWidth: 140, minWidth: 100 },
  { key: 'launch', label: 'LANZAMIENTO', defaultWidth: 140, minWidth: 100, fieldKeys: ['LANZAMIENTO'] },
  { key: 'material', label: 'MATERIAL', defaultWidth: 140, minWidth: 100, fieldKeys: ['MATERIAL'] },
  { key: 'caldereria', label: 'CALDERERÍA', defaultWidth: 140, minWidth: 100, fieldKeys: ['CALDERERIA', 'CALDERERÍA'] },
  { key: 'mecanizado', label: 'MECANIZADO', defaultWidth: 140, minWidth: 100, fieldKeys: ['MECANIZADO'] },
  { key: 'tratamiento', label: 'TRATAMIENTO', defaultWidth: 140, minWidth: 100, fieldKeys: ['TRATAMIENTO'] },
  { key: 'pintar', label: 'PINTAR', defaultWidth: 140, minWidth: 100, fieldKeys: ['PINTAR', 'PINTADO'] },
  { key: 'phase_start', label: 'Inicio fase planificada', defaultWidth: 170, minWidth: 120 },
  { key: 'phase_end', label: 'Fin fase planificada', defaultWidth: 170, minWidth: 120 },
  { key: 'summary', label: 'Resumen', defaultWidth: 260, minWidth: 180, isSummary: true },
];

const SUMMARY_COLUMN_STORAGE_KEY = 'ganttSummaryColumnWidths';

function loadSummaryColumnWidths() {
  let stored = {};
  try {
    const raw = localStorage.getItem(SUMMARY_COLUMN_STORAGE_KEY);
    if (raw) stored = JSON.parse(raw) || {};
  } catch (err) {
    stored = {};
  }
  return SUMMARY_COLUMN_DEFS.map(col => {
    const raw = stored[col.key];
    const width = Number(raw);
    if (Number.isFinite(width) && width > 0) {
      return Math.max(col.minWidth || 60, width);
    }
    return col.defaultWidth;
  });
}

let summaryColumnWidths = loadSummaryColumnWidths();

function saveSummaryColumnWidths() {
  const payload = {};
  SUMMARY_COLUMN_DEFS.forEach((col, idx) => {
    payload[col.key] = Math.max(col.minWidth || 60, Math.round(summaryColumnWidths[idx] || col.defaultWidth));
  });
  try {
    localStorage.setItem(SUMMARY_COLUMN_STORAGE_KEY, JSON.stringify(payload));
  } catch (err) {
    console.warn('No se pudo guardar el tamaño de las columnas', err);
  }
}

function updateSummaryGridColumns() {
  if (!summaryContainer) return;
  const template = summaryColumnWidths
    .map((width, idx) => `${Math.max(SUMMARY_COLUMN_DEFS[idx].minWidth || 60, Math.round(width || SUMMARY_COLUMN_DEFS[idx].defaultWidth))}px`)
    .join(' ');
  summaryContainer.style.setProperty('--summary-grid', template);
}

function attachSummaryResizers() {
  if (!summaryHeaderRow) return;
  summaryHeaderRow.querySelectorAll('.summary-col-resizer').forEach(handle => {
    handle.addEventListener('mousedown', ev => {
      if (ev.button !== 0) return;
      ev.preventDefault();
      ev.stopPropagation();
      const index = Number(handle.dataset.index);
      if (!Number.isFinite(index)) return;
      const startX = ev.clientX;
      const startWidth = summaryColumnWidths[index] || SUMMARY_COLUMN_DEFS[index].defaultWidth;
      const minWidth = SUMMARY_COLUMN_DEFS[index].minWidth || 60;
      const onMouseMove = moveEv => {
        const delta = moveEv.clientX - startX;
        const next = Math.max(minWidth, startWidth + delta);
        summaryColumnWidths[index] = next;
        updateSummaryGridColumns();
      };
      const onMouseUp = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.body.style.cursor = '';
        saveSummaryColumnWidths();
      };
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.body.style.cursor = 'col-resize';
    });
  });
}

function buildSummaryHeader() {
  if (!summaryHeaderRow) return;
  summaryHeaderRow.innerHTML = '';
  SUMMARY_COLUMN_DEFS.forEach((col, index) => {
    const cell = document.createElement('div');
    cell.className = 'summary-cell';
    cell.textContent = col.label;
    const handle = document.createElement('div');
    handle.className = 'summary-col-resizer';
    handle.dataset.index = index;
    cell.appendChild(handle);
    summaryHeaderRow.appendChild(cell);
  });
  attachSummaryResizers();
}

updateSummaryGridColumns();
buildSummaryHeader();

document.addEventListener('click', () => {
  if (popup) popup.style.display = 'none';
});
if (popup) {
  popup.addEventListener('click', (e) => e.stopPropagation());
}

function makeDraggable(el) {
  if (!el) return;
  let startX, startY, startLeft, startTop;
  const onMouseMove = (ev) => {
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    el.style.left = startLeft + dx + 'px';
    el.style.top = startTop + dy + 'px';
  };
  const onMouseUp = () => {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  };
  el.addEventListener('mousedown', (ev) => {
    if (ev.target.closest('input, textarea, select, button')) return;
    startX = ev.clientX;
    startY = ev.clientY;
    const rect = el.getBoundingClientRect();
    startLeft = rect.left + window.scrollX;
    startTop = rect.top + window.scrollY;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
}

document.querySelectorAll('.modal-content, .conflict-content, .info-popup').forEach(makeDraggable);

function pickDateValue(...values) {
  for (const value of values) {
    const text = (value ?? '').toString().trim();
    if (text && text !== '0') return text;
  }
  return '';
}

function getProjectInfo(row) {
  if (!row || !row.project) return null;
  const pid = row.project.id;
  if (!pid) return null;
  return (PROJECT_DATA && PROJECT_DATA[pid]) || null;
}

function getKanbanFieldsMap(info) {
  if (!info) return {};
  if (!info._kanbanFieldMap) {
    const map = {};
    const fields = info.kanban_display_fields || {};
    Object.entries(fields).forEach(([label, value]) => {
      const norm = normalizeColumnKey(label);
      if (!norm || norm in map) return;
      map[norm] = value;
    });
    info._kanbanFieldMap = map;
  }
  return info._kanbanFieldMap;
}

function getKanbanDateValue(info, labels) {
  if (!info || !Array.isArray(labels)) return '';
  const map = getKanbanFieldsMap(info);
  for (const label of labels) {
    const norm = normalizeColumnKey(label);
    if (!norm) continue;
    const raw = map[norm];
    const text = (raw ?? '').toString().trim();
    if (text && text !== '0') return text;
  }
  return '';
}

function formatDisplayDate(value) {
  const text = (value ?? '').toString().trim();
  if (!text || text === '0') return '';
  const iso = text.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return `${iso[3]}/${iso[2]}/${iso[1]}`;
  const slash = text.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (slash) return `${slash[1]}/${slash[2]}/${slash[3]}`;
  const parsed = new Date(text);
  if (!Number.isNaN(parsed.getTime())) {
    const day = String(parsed.getUTCDate()).padStart(2, '0');
    const month = String(parsed.getUTCMonth() + 1).padStart(2, '0');
    const year = parsed.getUTCFullYear();
    return `${day}/${month}/${year}`;
  }
  return text;
}

function showDeadline(text = DEADLINE_MSG, after = null) {
  if (!deadlineModal || !deadlineText || !deadlineClose) return;
  deadlineText.innerHTML = text.replace(/\n/g, '<br>');
  deadlineText.style.color = text.startsWith(CLIENT_DEADLINE_MSG) ? 'black' : 'orange';
  deadlineModal.style.display = 'block';
  deadlineClose.onclick = () => {
    deadlineModal.style.display = 'none';
    if (after) after();
  };
}

function afterMove(data, originalDate) {
  localStorage.setItem(LAST_KEY, JSON.stringify({pid: data.pid, phase: data.phase, part: data.part, date: data.date}));
  if (data.date !== originalDate) localStorage.setItem(SCROLL_KEY2, data.date);
  if (data.warning) showDeadline(data.warning, () => location.reload());
  else location.reload();
}

if (obsCancel) {
  obsCancel.addEventListener('click', () => { if (obsModal) obsModal.style.display = 'none'; });
}
if (obsModal) {
  obsModal.addEventListener('click', (e) => { if (e.target === obsModal) obsModal.style.display = 'none'; });
}
if (obsSave) {
  obsSave.addEventListener('click', () => {
    if (!obsModal) return;
    const pid = obsModal.dataset.pid;
    const txt = obsText.value;
    const url = OBS_URL_TEMPLATE.replace('__PID__', encodeURIComponent(pid));
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ observations: txt })
    }).then(() => {
      if (PROJECT_DATA[pid]) PROJECT_DATA[pid].observations = txt;
      obsModal.style.display = 'none';
    });
  });
}

if (splitCancel) {
  splitCancel.addEventListener('click', () => { if (splitModal) splitModal.style.display = 'none'; });
}
if (splitForm) {
  splitForm.addEventListener('submit', (ev) => {
    ev.preventDefault();
    ev.stopPropagation();
    fetch(SPLIT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        pid: splitModal.dataset.pid,
        phase: splitModal.dataset.phase,
        date: splitModal.dataset.date,
        part1: splitPart1.value,
        part2: splitPart2.value
      })
    }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
  });
}

function buildPhaseSection(info, context) {
  const phaseLines = [];
  PHASES.forEach(ph => {
    if (ph === 'dibujo' || ph === 'pedidos') return;
    const raw = info.phases ? info.phases[ph] : null;
    let total = 0;
    if (Array.isArray(raw)) total = raw.map(v => parseInt(v)).reduce((a,b) => a + b, 0);
    else total = parseInt(raw) || 0;
    if (total > 0) {
      const assigned = (info.assigned && info.assigned[ph]) || 'Sin planificar';
      const cls = assigned === 'Sin planificar' ? ' class="unplanned"' : ' class="planned"';
      let line = `<div${cls}>${ph}: ${total}h`;
      if (ph === context.phase) {
        line += ` <form id="phase-hours-form" style="display:inline"><input type="number" id="phase-hours-input" value="${total}" min="1" required><button type="submit" data-pid="${context.pid}" data-phase="${ph}">Cambiar horas</button></form>`;
      }
      line += `</div>`;
      phaseLines.push(line);
    }
  });
  let section = '';
  if (phaseLines.length) section += phaseLines.join('');
  if (context.phase === 'pedidos') {
    const acopio = info.phases ? info.phases['pedidos'] : null;
    if (acopio && acopio !== '0') section += `<div>Plazo acopio: ${acopio}</div>`;
  }
  return section;
}

function openPhasePopup(context, anchorRect) {
  if (!popup) return;
  const info = PROJECT_DATA[context.pid];
  if (!info) return;
  const headerParts = [info.name];
  if (info.blocked) headerParts[0] += ' <span class="blocked-sign">\u{1F6AB}</span>';
  headerParts.push(info.client || '');
  if (context.phase) headerParts.push(context.phase);
  let html = `<div class="popup-section popup-header"><strong>${headerParts.filter(Boolean).join(' - ')}</strong></div>`;
  const metaLines = [];
  if (info.due_date && info.due_date !== '0') metaLines.push(`<div>Límite: ${info.due_date}</div>`);
  if (info.material_confirmed_date && info.material_confirmed_date !== '0') metaLines.push(`<div>Material confirmado: ${info.material_confirmed_date}</div>`);
  if (metaLines.length) html += `<div class="popup-section">${metaLines.join('')}</div>`;
  const kanbanFields = info.kanban_display_fields || {};
  const kanbanEntries = Object.entries(kanbanFields).filter(([, value]) => value !== null && value !== undefined && `${value}`.trim() !== '');
  if (kanbanEntries.length) {
    let kanbanHtml = '<div class="popup-section kanban-extra-fields">';
    kanbanEntries.forEach(([label, value]) => {
      kanbanHtml += `<div>${label}: ${value}</div>`;
    });
    kanbanHtml += '</div>';
    html += kanbanHtml;
  }
  const phaseSection = buildPhaseSection(info, context);
  if (phaseSection) html += `<div class="popup-section">${phaseSection}</div>`;
  const actionLines = [];
  if (context.phase) {
    const startVal = (START_DATA[context.pid] && START_DATA[context.pid][context.phase]) || '';
    actionLines.push(`<div>Inicio de la fase: <form id="start-form" style="display:inline"><input type="date" id="start-input" value="${startVal}" required><button type="submit" id="start-btn" data-pid="${context.pid}" data-phase="${context.phase}">Cambiar</button></form></div>`);
    actionLines.push(`<div><button id="freeze-btn" data-pid="${context.pid}" data-phase="${context.phase}" style="color:red;font-weight:bold">${(info.frozen_phases && info.frozen_phases.includes(context.phase)) ? 'Descongelar' : 'Congelar'}</button></div>`);
    let splitLine = `<div><button id="split-btn" data-pid="${context.pid}" data-phase="${context.phase}" data-date="${context.day}">Dividir fase aquí</button>`;
    if (info.phases && Array.isArray(info.phases[context.phase])) {
      splitLine += ` <button id="unsplit-btn" data-pid="${context.pid}" data-phase="${context.phase}">Deshacer división</button>`;
    }
    splitLine += `</div>`;
    actionLines.push(splitLine);
    actionLines.push(`<div><button class="phase-delete-btn" id="del-btn" data-pid="${context.pid}" data-phase="${context.phase}">&#10060; Borrar fase</button></div>`);
    actionLines.push(`<div><button id="unplan-btn" data-pid="${context.pid}" data-phase="${context.phase}" data-part="${context.part || ''}">Sin planificar</button></div>`);
  }
  actionLines.push(`<div><button id="obs-btn" data-pid="${context.pid}">OBSERVACIONES</button></div>`);
  if (info.image) {
    const imgUrl = `${STATIC_URL}${info.image}`;
    actionLines.push(`<div><a href="${imgUrl}" target="_blank"><img src="${imgUrl}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
  }
  if (info.kanban_attachments && info.kanban_attachments.length) {
    info.kanban_attachments.forEach(att => {
      const url = att.url;
      const name = (att.name || '').toLowerCase();
      if (/\.(png|jpe?g|gif|webp|bmp|svg)$/.test(name)) {
        actionLines.push(`<div><a href="${url}" target="_blank"><img src="${url}" alt="${att.name || ''}" style="max-width:200px;display:block;margin-top:4px;"></a></div>`);
      } else {
        actionLines.push(`<div><a href="${url}" target="_blank">${att.name || url}</a></div>`);
      }
    });
  }
  if (actionLines.length) html += `<div class="popup-section">${actionLines.join('')}</div>`;
  popup.innerHTML = html;
  popup.style.left = (anchorRect.left + window.scrollX + 5) + 'px';
  popup.style.top = (anchorRect.bottom + window.scrollY + 5) + 'px';
  popup.style.display = 'block';

  const del = document.getElementById('del-btn');
  if (del) {
    del.addEventListener('click', ev => {
      ev.stopPropagation();
      if (confirm('¿Borrar fase?')) {
        fetch(DELETE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ pid: del.dataset.pid, phase: del.dataset.phase })
        }).then(() => location.reload());
      }
    });
  }
  const unplan = document.getElementById('unplan-btn');
  if (unplan) {
    unplan.addEventListener('click', ev => {
      ev.stopPropagation();
      const today = madridDateISO();
      const body = { pid: unplan.dataset.pid, phase: unplan.dataset.phase, date: today, worker: 'Sin planificar' };
      if (unplan.dataset.part) body.part = unplan.dataset.part;
      fetch(MOVE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
      })
        .then(resp => resp.json().then(d => ({ ok: resp.ok, data: d })))
        .then(({ ok, data }) => {
          if (!ok) {
            if (data.error === DEADLINE_MSG || data.error === CLIENT_DEADLINE_MSG) showDeadline(data.error);
            else alert(data.error || 'Error');
            return;
          }
          afterMove(data, today);
        });
    });
  }
  const obsBtn = document.getElementById('obs-btn');
  if (obsBtn && obsModal) {
    obsBtn.addEventListener('click', ev => {
      ev.stopPropagation();
      const pid = obsBtn.dataset.pid;
      obsModal.dataset.pid = pid;
      obsText.value = (PROJECT_DATA[pid] && PROJECT_DATA[pid].observations) || '';
      obsModal.style.display = 'block';
    });
  }
  const splitBtn = document.getElementById('split-btn');
  if (splitBtn && splitModal) {
    splitBtn.addEventListener('click', ev => {
      ev.stopPropagation();
      splitModal.dataset.pid = splitBtn.dataset.pid;
      splitModal.dataset.phase = splitBtn.dataset.phase;
      splitModal.dataset.date = splitBtn.dataset.date;
      splitPart1.value = '';
      splitPart2.value = '';
      splitModal.style.display = 'block';
    });
  }
  const unsplitBtn = document.getElementById('unsplit-btn');
  if (unsplitBtn) {
    unsplitBtn.addEventListener('click', ev => {
      ev.stopPropagation();
      if (confirm('¿Deshacer división de esta fase?')) {
        fetch(UNSPLIT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ pid: unsplitBtn.dataset.pid, phase: unsplitBtn.dataset.phase })
        }).then(resp => { if (resp.ok) location.reload(); else resp.json().then(d => alert(d.error || 'Error')); });
      }
    });
  }
  const freeze = document.getElementById('freeze-btn');
  if (freeze) {
    freeze.addEventListener('click', ev => {
      ev.stopPropagation();
      fetch('/toggle_freeze/' + freeze.dataset.pid + '/' + encodeURIComponent(freeze.dataset.phase), { method: 'POST', credentials: 'same-origin' })
        .then(() => location.reload());
    });
  }
  const startForm = document.getElementById('start-form');
  if (startForm) {
    startForm.addEventListener('submit', ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const btn = document.getElementById('start-btn');
      const val = document.getElementById('start-input').value;
      fetch(START_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ pid: btn.dataset.pid, phase: btn.dataset.phase, date: val })
      }).then(resp => {
        if (!resp.ok) {
          return resp.json().then(d => { alert(d.error || 'Error'); return null; });
        }
        return resp.json();
      }).then(d => {
        if (d) {
          localStorage.setItem(LAST_KEY, JSON.stringify({pid: btn.dataset.pid, phase: btn.dataset.phase, date: d.date}));
          if (d.date !== val) localStorage.setItem(SCROLL_KEY2, d.date);
        }
        location.reload();
      });
    });
  }
  const hoursForm = document.getElementById('phase-hours-form');
  if (hoursForm) {
    hoursForm.addEventListener('submit', ev => {
      ev.preventDefault();
      ev.stopPropagation();
      const btn = hoursForm.querySelector('button');
      const val = document.getElementById('phase-hours-input').value;
      fetch(PHASE_HOURS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ pid: btn.dataset.pid, phase: btn.dataset.phase, hours: val })
      }).then(resp => {
        if (resp.ok) {
          const url = new URL(location);
          url.searchParams.set('highlight', btn.dataset.pid);
          location.href = url;
        } else {
          resp.json().then(d => alert(d.error || 'Error'));
        }
      });
    });
  }
}

const summaryResizer = document.getElementById('summary-resizer');
const SUMMARY_WIDTH_KEY = 'ganttSummaryWidth';
const savedSummaryWidth = localStorage.getItem(SUMMARY_WIDTH_KEY);
if(savedSummaryWidth){ summaryContainer.style.width = savedSummaryWidth + 'px'; }
if(summaryResizer){
  let startX, startWidth;
  const onMouseMove = e => {
    const dx = e.clientX - startX;
    const newWidth = Math.max(150, startWidth + dx);
    summaryContainer.style.width = newWidth + 'px';
  };
  const onMouseUp = () => {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    localStorage.setItem(SUMMARY_WIDTH_KEY, summaryContainer.offsetWidth);
  };
  summaryResizer.addEventListener('mousedown', e => {
    startX = e.clientX;
    startWidth = summaryContainer.offsetWidth;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
}

function formatDate(d){return d.split('T')[0];}

function sortProjects(type, store=true){
  if(!type){
    currentSort = null;
    if(store) localStorage.removeItem('ganttSort');
    render();
    return;
  }
  projects.sort((a,b)=>{
    const da = type==='start'? new Date(a.start) : new Date(a.due_date || '9999-12-31');
    const db = type==='start'? new Date(b.start) : new Date(b.due_date || '9999-12-31');
    return da - db;
  });
  currentSort = type;
  if(store) localStorage.setItem('ganttSort', type);
  render();
}

function applyFilters(store=true){
  const projectRaw = projectFilterInput.value.trim();
  const clientRaw = clientFilterInput.value.trim();
  const projectTerm = projectRaw.toLowerCase();
  const clientTerm = clientRaw.toLowerCase();
  if(store){
    if(projectRaw){
      localStorage.setItem(FILTER_PROJECT_KEY, projectRaw);
    } else {
      localStorage.removeItem(FILTER_PROJECT_KEY);
    }
    if(clientRaw){
      localStorage.setItem(FILTER_CLIENT_KEY, clientRaw);
    } else {
      localStorage.removeItem(FILTER_CLIENT_KEY);
    }
  }
  projects = allProjects.filter(p=>{
    const matchesProject = !projectTerm || p.name.toLowerCase().includes(projectTerm);
    const matchesClient = !clientTerm || (p.client || '').toLowerCase().includes(clientTerm);
    return matchesProject && matchesClient;
  });
  if(currentSort){
    sortProjects(currentSort, false);
    return;
  }
  render();
}

function render(){
  summaryBody.innerHTML = '';
  body.innerHTML = '';
  header.innerHTML = '';
  updateSummaryGridColumns();
  if(!projects.length){return;}
  const dayMs = DAY_MS;
  const startOfDay = d => {
    const raw = (d ?? '').toString().trim();
    if(!raw){
      return new Date(NaN);
    }
    const normalized = raw.replace(' ', 'T');
    const base = normalized.split('T')[0];
    return new Date(base + 'T00:00:00');
  };
  const allStarts = [];
  const allEnds = [];
  projects.forEach(p=>{
    const ps = startOfDay(p.start);
    const pe = startOfDay(p.end);
    allStarts.push(ps.getTime());
    allEnds.push(pe.getTime());
    p.phases.forEach(ph=>{
      const s = startOfDay(ph.start);
      const e = startOfDay(ph.end);
      allStarts.push(s.getTime());
      allEnds.push(e.getTime());
    });
  });
  const minStart = Math.min(...allStarts);
  const maxEnd = Math.max(...allEnds);
  const totalDays = Math.round((maxEnd - minStart)/dayMs) + 1;
  timelineMinStart = minStart;
  pxPerDay = 40 * zoom;
  timelinePxPerDay = pxPerDay;
  const width = totalDays * pxPerDay;
  header.style.width = width + 'px';
  body.style.width = width + 'px';
  body.style.background = `repeating-linear-gradient(to right, #ddd, #ddd 1px, transparent 1px, transparent ${pxPerDay}px)`;
  header.style.background = body.style.background;
  const todayStr = madridDateISO();
  todayIndex = null;

  for(let i=0;i<totalDays;i++){
    const d = new Date(minStart + i*dayMs);
    const iso = madridDateISO(d);
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.style.left = (i*pxPerDay) + 'px';
    cell.style.width = pxPerDay + 'px';
    cell.textContent = d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'});
    if(iso === todayStr){ cell.classList.add('today'); todayIndex = i; }
    header.appendChild(cell);
  }

  if(todayIndex !== null){
    const highlight = document.createElement('div');
    highlight.className = 'today-column';
    highlight.style.left = (todayIndex*pxPerDay) + 'px';
    highlight.style.width = pxPerDay + 'px';
    body.appendChild(highlight);
  }

  const rows = [];
  projects.forEach(p=>{
    rows.push({type:'project', project:p});
    if(!collapsed[p.id]){
      p.phases.forEach(ph=>rows.push({type:'phase', project:p, phase:ph}));
    }
  });

  rows.forEach(r=>{
    const summaryRow = document.createElement('div');
    summaryRow.className = 'summary-row summary-grid ' + (r.type==='project'?'project-row':'phase-row');
    const info = getProjectInfo(r);
    const pid = r.project.id;
    const startMap = (START_DATA && START_DATA[pid]) || null;
    SUMMARY_COLUMN_DEFS.forEach(col => {
      const cell = document.createElement('div');
      cell.className = 'summary-cell';
      let value = '';
      if (col.isSummary) {
        cell.classList.add('summary-text');
        if (r.type === 'project') {
          cell.classList.add('project');
          value = `${r.project.name}${r.project.client ? ' - ' + r.project.client : ''}`;
          cell.addEventListener('click', () => toggleProject(r.project.id));
        } else {
          cell.classList.add('phase');
          value = `${r.phase.name}${r.phase.worker ? ' - ' + r.phase.worker : ''}`;
        }
      } else if (col.key === 'due_date') {
        value = formatDisplayDate(pickDateValue(r.project.due_date, info && info.due_date, r.project.deadline_start, info && info.deadline_start));
      } else if (col.key === 'phase_start') {
        if (r.type === 'phase') {
          const startValue = pickDateValue(startMap && startMap[r.phase.name], r.phase.start);
          value = formatDisplayDate(startValue);
        }
      } else if (col.key === 'phase_end') {
        if (r.type === 'phase') {
          value = formatDisplayDate(pickDateValue(r.phase.end));
        }
      } else if (col.fieldKeys) {
        value = formatDisplayDate(getKanbanDateValue(info, col.fieldKeys));
      }
      cell.textContent = value || '';
      if (value) cell.title = value;
      else cell.removeAttribute('title');
      summaryRow.appendChild(cell);
    });
    summaryBody.appendChild(summaryRow);

    const rowDiv = document.createElement('div');
    rowDiv.className = 'gantt-row ' + (r.type==='project'?'project-row':'phase-row');
    const bar = document.createElement('div');
    bar.className = 'gantt-task ' + (r.type==='project'?'project-bar':'phase-bar');
    const startMs = startOfDay(r.type==='project'?r.project.start:r.phase.start).getTime();
    const endMs = startOfDay(r.type==='project'?r.project.end:r.phase.end).getTime();
    bar.style.left = ((startMs - minStart)/dayMs*pxPerDay) + 'px';
    bar.style.width = (((endMs - startMs)/dayMs + 1)*pxPerDay) + 'px';
    bar.style.background = r.type==='project'?(r.project.color || '#3a87ad'):(r.phase.color || r.project.color || '#6c9ec1');
    bar.textContent = r.type==='project'?`${r.project.name} - ${r.project.client} (${formatDate(r.project.start)} - ${formatDate(r.project.end)})`:r.phase.name;
    if(r.type==='project'){
      const deadlineSources = [
        r.project.deadline_start,
        r.project.due_date,
        r.project.client_date,
        r.project.client_due_date
      ];
      const seenDeadlines = new Set();
      deadlineSources.forEach(raw => {
        const deadlineDate = startOfDay(raw);
        const deadlineMs = deadlineDate.getTime();
        if(Number.isNaN(deadlineMs) || seenDeadlines.has(deadlineMs)) return;
        seenDeadlines.add(deadlineMs);
        if(deadlineMs <= endMs){
          const highlightStart = Math.max(deadlineMs, minStart);
          if(highlightStart <= endMs){
            const leftPx = ((highlightStart - minStart)/dayMs) * pxPerDay;
            const widthDays = Math.round((endMs - highlightStart)/dayMs) + 1;
            if(widthDays > 0){
              const highlight = document.createElement('div');
              highlight.className = 'deadline-highlight';
              highlight.style.left = leftPx + 'px';
              highlight.style.width = (widthDays * pxPerDay) + 'px';
              rowDiv.appendChild(highlight);
            }
          }
        }
      });
      bar.addEventListener('click', evt => {
        evt.stopPropagation();
        const barWidthDays = Math.max(0, Math.round((endMs - startMs)/dayMs));
        const relativePx = Math.max(0, Math.min((evt.offsetX ?? 0), bar.clientWidth));
        let dayOffset = Math.floor(relativePx / pxPerDay);
        if(dayOffset > barWidthDays) dayOffset = barWidthDays;
        let clickedMs = startMs + dayOffset * dayMs;
        const phases = Array.isArray(r.project.phases) ? r.project.phases : [];
        let chosen = null;
        let minDist = Infinity;
        phases.forEach(ph => {
          const phStart = startOfDay(ph.start).getTime();
          const phEnd = startOfDay(ph.end).getTime();
          let dist = 0;
          if(clickedMs < phStart) dist = phStart - clickedMs;
          else if(clickedMs > phEnd) dist = clickedMs - phEnd;
          if(dist < minDist){
            minDist = dist;
            chosen = { data: ph, start: phStart, end: phEnd };
          }
        });
        if(chosen){
          if(clickedMs < chosen.start) clickedMs = chosen.start;
          if(clickedMs > chosen.end) clickedMs = chosen.end;
        } else {
          if(clickedMs < startMs) clickedMs = startMs;
          if(clickedMs > endMs) clickedMs = endMs;
        }
        const isoDay = madridDateISO(clickedMs);
        openPhasePopup({
          pid: r.project.id,
          phase: chosen ? chosen.data.name : '',
          day: isoDay,
          worker: chosen && chosen.data.worker ? chosen.data.worker : '',
          part: ''
        }, bar.getBoundingClientRect());
      });
    } else {
      bar.addEventListener('click', evt => {
        evt.stopPropagation();
        const relativePx = Math.max(0, Math.min((evt.offsetX ?? 0), bar.clientWidth));
        const totalDays = Math.max(0, Math.round((endMs - startMs)/dayMs));
        let dayOffset = Math.floor(relativePx / pxPerDay);
        if(dayOffset > totalDays) dayOffset = totalDays;
        let clickedMs = startMs + dayOffset * dayMs;
        if(clickedMs > endMs) clickedMs = endMs;
        const isoDay = madridDateISO(clickedMs);
        openPhasePopup({
          pid: r.project.id,
          phase: r.phase.name,
          day: isoDay,
          worker: r.phase.worker || '',
          part: ''
        }, bar.getBoundingClientRect());
      });
    }
    rowDiv.appendChild(bar);
    body.appendChild(rowDiv);
  });

  const totalHeight = rows.length * BAR_HEIGHT;
  summaryBody.style.height = totalHeight + 'px';
    body.style.height = totalHeight + 'px';
  if(initialScroll){ scrollToToday(); initialScroll=false; }
}

function scrollToToday(){
  if(todayIndex === null) return;
  main.scrollLeft = todayIndex * pxPerDay - main.clientWidth/2 + pxPerDay/2;
}

function toggleProject(id){
  collapsed[id] = !collapsed[id];
  localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed));
  render();
}

document.getElementById('expand_all').onclick = ()=>{projects.forEach(p=>collapsed[p.id]=false); localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed)); render();};
document.getElementById('collapse_all').onclick = ()=>{projects.forEach(p=>collapsed[p.id]=true); localStorage.setItem('ganttCollapsed', JSON.stringify(collapsed)); render();};
document.getElementById('zoom_in').onclick = ()=>{zoom*=1.25; localStorage.setItem('ganttZoom', zoom); render();};
document.getElementById('zoom_out').onclick = ()=>{zoom/=1.25; localStorage.setItem('ganttZoom', zoom); render();};
document.getElementById('sort_start').onclick = ()=>sortProjects('start');
document.getElementById('sort_due').onclick = ()=>sortProjects('due');
document.getElementById('go_today').onclick = scrollToToday;
projectFilterInput.addEventListener('input', ()=>applyFilters());
clientFilterInput.addEventListener('input', ()=>applyFilters());

let syncing = false;
function syncScroll(source, target){
  if(syncing) return;
  syncing = true;
  target.scrollTop = source.scrollTop;
  syncing = false;
}

main.addEventListener('scroll',()=>syncScroll(main, summaryContainer));
summaryContainer.addEventListener('scroll',()=>syncScroll(summaryContainer, main));

if (window.EventSource) {
  const ganttSource = new EventSource("{{ url_for('event_stream') }}");
  let ganttRefreshTimer = null;
  const queueGanttReload = () => {
    if (ganttRefreshTimer) return;
    ganttRefreshTimer = setTimeout(() => {
      ganttRefreshTimer = null;
      fetch(GANTT_DATA_URL, { credentials: 'same-origin' })
        .then(resp => {
          if (!resp.ok) throw new Error('No se pudo actualizar la vista Gantt');
          return resp.json();
        })
        .then(data => {
          allProjects = Array.isArray(data.projects) ? data.projects : [];
          PROJECT_DATA = data.project_data || {};
          START_DATA = data.start_map || {};
          applyFilters(false);
        })
        .catch(err => console.error('Error al actualizar datos del Gantt', err));
    }, 750);
  };
  ganttSource.onmessage = queueGanttReload;
  window.addEventListener('beforeunload', () => ganttSource.close());
}

applyFilters(false);
</script>
{% endblock %}
